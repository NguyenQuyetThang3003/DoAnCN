@model WedNightFury.Models.Profile
@using System.Text.Json

@{
    Layout = ViewBag.Layout ?? "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "C√†i ƒë·∫∑t t√†i kho·∫£n";
}

<div class="profile-page container py-4">

    <!-- Header -->
    <div class="page-head mb-3">
        <div class="d-flex align-items-center gap-3">
            <div class="page-icon">‚öôÔ∏è</div>
            <div>
                <h3 class="m-0 page-title">C√†i ƒë·∫∑t t√†i kho·∫£n</h3>
                <div class="page-sub text-muted">C·∫≠p nh·∫≠t th√¥ng tin c√° nh√¢n v√† ƒë·ªãa ch·ªâ xu·∫•t h√≥a ƒë∆°n</div>
            </div>
        </div>

        <div class="head-meta">
            <span class="meta-dot"></span>
            <span class="text-muted">T·ª± l∆∞u theo form</span>
        </div>
    </div>

    @if (ViewBag.Message != null)
    {
        <div class="alert alert-success shadow-sm mb-3" role="alert">
            @ViewBag.Message
        </div>
    }

    <form asp-action="Index" method="post" class="profile-card">
        @Html.AntiForgeryToken()

        <input type="hidden" asp-for="Id" />
        <input type="hidden" asp-for="UserId" />

        <!-- Section: Account -->
        <div class="section">
            <div class="section-head">
                <div class="sec-title">
                    <span class="sec-ic">üë§</span>
                    <span>Th√¥ng tin t√†i kho·∫£n</span>
                </div>
                <div class="sec-sub text-muted">Th√¥ng tin d√πng cho li√™n h·ªá v√† x√°c nh·∫≠n</div>
            </div>

            <div class="row g-3 mt-1">
                <div class="col-md-6">
                    <label class="form-label">T√™n kh√°ch h√†ng / C√¥ng ty</label>
                    <div class="input-wrap">
                        <span class="input-ic">üè∑Ô∏è</span>
                        <input asp-for="FullName" class="form-control input-control" placeholder="V√≠ d·ª•: Nguy·ªÖn VƒÉn A / C√¥ng ty ABC" />
                    </div>
                </div>

                <div class="col-md-6">
                    <label class="form-label">Email</label>
                    <div class="input-wrap">
                        <span class="input-ic">üìß</span>
                        <input asp-for="Email" class="form-control input-control" placeholder="example@gmail.com" />
                    </div>
                </div>

                <div class="col-md-6">
                    <label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                    <div class="input-wrap">
                        <span class="input-ic">üìû</span>
                        <input asp-for="Phone" class="form-control input-control" placeholder="090xxxxxxx" />
                    </div>
                </div>

                <div class="col-md-6">
                    <label class="form-label">Ng√†y sinh</label>
                    <div class="input-wrap">
                        <span class="input-ic">üìÖ</span>
                        <input asp-for="BirthDate" type="date" class="form-control input-control" />
                    </div>
                </div>

                <div class="col-md-6">
                    <label class="form-label">Ch·ª©ng minh th∆∞ / M√£ s·ªë thu·∫ø</label>
                    <div class="input-wrap">
                        <span class="input-ic">ü™™</span>
                        <input asp-for="TaxCode" class="form-control input-control" placeholder="V√≠ d·ª•: 0123456789" />
                    </div>
                </div>

                <div class="col-md-6">
                    <label class="form-label">T√™n c√¥ng ty (n·∫øu c√≥)</label>
                    <div class="input-wrap">
                        <span class="input-ic">üè¢</span>
                        <input asp-for="CompanyName" class="form-control input-control" placeholder="V√≠ d·ª•: C√¥ng ty TNHH ..." />
                    </div>
                </div>
            </div>
        </div>

        <!-- Section: Address -->
        <div class="section mt-3">
            <div class="section-head">
                <div class="sec-title">
                    <span class="sec-ic">üìç</span>
                    <span>ƒê·ªãa ch·ªâ & Khu v·ª±c</span>
                </div>
                <div class="sec-sub text-muted">Ch·ªçn ƒë√∫ng t·ªânh/huy·ªán/x√£ ƒë·ªÉ h·ªó tr·ª£ ƒë·ªãnh tuy·∫øn giao h√†ng</div>
            </div>

            <div class="row g-3 mt-1">
                <div class="col-12">
                    <label class="form-label">ƒê·ªãa ch·ªâ th∆∞·ªùng tr√∫ / ƒê·ªãa ch·ªâ xu·∫•t h√≥a ƒë∆°n</label>
                    <div class="input-wrap">
                        <span class="input-ic">üè†</span>
                        <input asp-for="Address" class="form-control input-control" placeholder="S·ªë nh√†, ƒë∆∞·ªùng, ph∆∞·ªùng/x√£..." />
                    </div>
                </div>

                <div class="col-md-4">
                    <label class="form-label">T·ªânh / Th√†nh ph·ªë</label>
                    <select asp-for="City" class="form-select select-control" id="citySelect">
                        <option value="">-- Ch·ªçn t·ªânh / th√†nh ph·ªë --</option>
                    </select>
                </div>

                <div class="col-md-4">
                    <label class="form-label">Qu·∫≠n / Huy·ªán</label>
                    <select asp-for="District" class="form-select select-control" id="districtSelect">
                        <option value="">-- Ch·ªçn qu·∫≠n / huy·ªán --</option>
                    </select>
                </div>

                <div class="col-md-4">
                    <label class="form-label">Ph∆∞·ªùng / X√£</label>
                    <select asp-for="Ward" class="form-select select-control" id="wardSelect">
                        <option value="">-- Ch·ªçn ph∆∞·ªùng / x√£ --</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="actions mt-4">
            <div class="text-muted small">
                * Nh·∫•n ‚ÄúL∆∞u thay ƒë·ªïi‚Äù ƒë·ªÉ c·∫≠p nh·∫≠t th√¥ng tin. D·ªØ li·ªáu v·ªã tr√≠ s·∫Ω t·ª± ƒë·ªông load theo t·ªânh/huy·ªán/x√£.
            </div>
            <button type="submit" class="btn btn-danger px-4 btn-save">
                üíæ L∆∞u thay ƒë·ªïi
            </button>
        </div>
    </form>
</div>

<style>
    .profile-page {
        --border: rgba(17, 24, 39, 0.12);
        --shadow: 0 10px 30px rgba(17, 24, 39, 0.08);
        --shadow2: 0 14px 40px rgba(17, 24, 39, 0.10);
        font-family: "Segoe UI", system-ui, -apple-system, Arial, sans-serif;
    }

    /* Header */
    .page-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 14px;
        padding: 14px 16px;
        border-radius: 16px;
        border: 1px solid var(--border);
        background: linear-gradient(180deg, rgba(220, 53, 69, 0.10), rgba(220, 53, 69, 0.02));
        box-shadow: var(--shadow);
        flex-wrap: wrap;
    }

    .page-icon {
        width: 44px;
        height: 44px;
        border-radius: 14px;
        display: grid;
        place-items: center;
        background: #fff;
        border: 1px solid var(--border);
        box-shadow: 0 8px 24px rgba(17, 24, 39, 0.08);
        font-size: 20px;
        flex: 0 0 auto;
    }

    .page-title {
        font-weight: 900;
        letter-spacing: -0.2px;
        color: #dc3545;
        text-transform: uppercase;
        font-size: 1.15rem;
    }

    .page-sub { margin-top: 4px; font-size: 0.95rem; }

    .head-meta {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: #fff;
        box-shadow: 0 8px 18px rgba(17, 24, 39, 0.06);
        font-weight: 700;
        font-size: 0.9rem;
        user-select: none;
    }

    .meta-dot {
        width: 10px;
        height: 10px;
        border-radius: 99px;
        background: #22c55e;
        box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.18);
    }

    /* Card */
    .profile-card {
        border-radius: 18px;
        border: 1px solid var(--border);
        background: #fff;
        box-shadow: var(--shadow);
        padding: 18px;
    }

    /* Sections */
    .section {
        border: 1px solid rgba(17, 24, 39, 0.08);
        border-radius: 16px;
        padding: 14px 14px 16px 14px;
        background: linear-gradient(180deg, rgba(17, 24, 39, 0.02), rgba(17, 24, 39, 0.01));
    }

    .section-head {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
        padding-bottom: 10px;
        border-bottom: 1px dashed rgba(17, 24, 39, 0.12);
        margin-bottom: 10px;
    }

    .sec-title {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        font-weight: 900;
        color: #0d6efd;
        letter-spacing: -0.2px;
    }

    .sec-ic {
        width: 34px;
        height: 34px;
        border-radius: 14px;
        display: grid;
        place-items: center;
        background: #fff;
        border: 1px solid rgba(17, 24, 39, 0.10);
        box-shadow: 0 8px 18px rgba(17, 24, 39, 0.06);
    }

    .sec-sub { font-size: 0.92rem; }

    /* Inputs */
    .form-label { font-weight: 800; color: #111827; }

    .input-wrap { position: relative; }
    .input-ic {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        opacity: 0.6;
        font-size: 15px;
    }

    .input-control {
        padding-left: 38px;
        border-radius: 12px;
        border: 1px solid rgba(17, 24, 39, 0.15);
        box-shadow: 0 6px 18px rgba(17, 24, 39, 0.06);
        transition: all .15s ease;
    }

    .input-control:focus {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.18);
    }

    .select-control {
        border-radius: 12px;
        border: 1px solid rgba(17, 24, 39, 0.15);
        box-shadow: 0 6px 18px rgba(17, 24, 39, 0.05);
        transition: all .15s ease;
    }

    .select-control:focus {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.18);
    }

    /* Actions */
    .actions {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding-top: 14px;
        border-top: 1px dashed rgba(17, 24, 39, 0.12);
        flex-wrap: wrap;
    }

    .btn-save {
        border-radius: 12px;
        box-shadow: 0 12px 26px rgba(220, 53, 69, 0.22);
        font-weight: 800;
    }
</style>

@section Scripts {
    <script>
        // Gi√° tr·ªã ƒëang l∆∞u trong profile (server tr·∫£ v·ªÅ)
        const currentCity     = @Html.Raw(JsonSerializer.Serialize(Model?.City ?? ""));
        const currentDistrict = @Html.Raw(JsonSerializer.Serialize(Model?.District ?? ""));
        const currentWard     = @Html.Raw(JsonSerializer.Serialize(Model?.Ward ?? ""));

        let provinces = [];

        // L·∫•y danh s√°ch t·ªânh / huy·ªán / x√£ t·ª´ GitHub
        fetch("https://raw.githubusercontent.com/kenzouno1/DiaGioiHanhChinhVN/master/data.json")
            .then(res => {
                if (!res.ok) throw new Error("Network response was not ok");
                return res.json();
            })
            .then(data => {
                provinces = data;
                initLocation();
            })
            .catch(err => {
                console.error("Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu ƒë·ªãa gi·ªõi h√†nh ch√≠nh:", err);
            });

        function initLocation() {
            const citySelect     = document.getElementById("citySelect");
            const districtSelect = document.getElementById("districtSelect");
            const wardSelect     = document.getElementById("wardSelect");

            if (!citySelect) return;

            citySelect.innerHTML = '<option value="">-- Ch·ªçn t·ªânh / th√†nh ph·ªë --</option>';

            provinces.forEach(p => {
                const opt = document.createElement("option");
                opt.value = p.Name;
                opt.text  = p.Name;
                opt.dataset.id = p.Id;
                if (p.Name === currentCity) opt.selected = true;
                citySelect.appendChild(opt);
            });

            citySelect.addEventListener("change", loadDistricts);

            if (currentCity) {
                loadDistricts();
            }

            districtSelect.addEventListener("change", loadWards);
        }

        function loadDistricts() {
            const citySelect     = document.getElementById("citySelect");
            const districtSelect = document.getElementById("districtSelect");
            const wardSelect     = document.getElementById("wardSelect");

            districtSelect.innerHTML = '<option value="">-- Ch·ªçn qu·∫≠n / huy·ªán --</option>';
            wardSelect.innerHTML     = '<option value="">-- Ch·ªçn ph∆∞·ªùng / x√£ --</option>';

            const cityOpt = citySelect.selectedOptions[0];
            if (!cityOpt) return;

            const provinceId = cityOpt.dataset.id;
            const province = provinces.find(p => p.Id == provinceId);
            if (!province) return;

            province.Districts.forEach(d => {
                const opt = document.createElement("option");
                opt.value = d.Name;
                opt.text  = d.Name;
                opt.dataset.id = d.Id;
                if (d.Name === currentDistrict) opt.selected = true;
                districtSelect.appendChild(opt);
            });

            if (currentDistrict) {
                loadWards();
            }
        }

        function loadWards() {
            const citySelect     = document.getElementById("citySelect");
            const districtSelect = document.getElementById("districtSelect");
            const wardSelect     = document.getElementById("wardSelect");

            wardSelect.innerHTML = '<option value="">-- Ch·ªçn ph∆∞·ªùng / x√£ --</option>';

            const cityOpt = citySelect.selectedOptions[0];
            const distOpt = districtSelect.selectedOptions[0];
            if (!cityOpt || !distOpt) return;

            const provinceId = cityOpt.dataset.id;
            const districtId = distOpt.dataset.id;

            const province = provinces.find(p => p.Id == provinceId);
            if (!province) return;
            const district = province.Districts.find(d => d.Id == districtId);
            if (!district) return;

            district.Wards.forEach(w => {
                const opt = document.createElement("option");
                opt.value = w.Name;
                opt.text  = w.Name;
                if (w.Name === currentWard) opt.selected = true;
                wardSelect.appendChild(opt);
            });
        }
    </script>
}
