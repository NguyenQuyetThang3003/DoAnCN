@using System
@using System.Linq
@using System.Text.Json

@{
    ViewData["Title"] = "Dashboard";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var success = ViewBag.SuccessCount ?? 0;
    var failed = ViewBag.FailCount ?? 0;
    var total = ViewBag.TotalOrders ?? 0;
    var barData = ViewBag.BarData as IEnumerable<dynamic> ?? Enumerable.Empty<dynamic>();
    var pieData = ViewBag.PieData as IEnumerable<dynamic> ?? Enumerable.Empty<dynamic>();
    var lastUpdate = ViewBag.LastUpdate ?? DateTime.Now.ToString("HH:mm");
    var customer = ViewBag.CustomerName ?? "Kh√°ch h√†ng";

    DateTime fromDate = ViewBag.FromDate ?? DateTime.Today;
    DateTime toDate = ViewBag.ToDate ?? DateTime.Today;

    var rate = (success + failed) == 0 ? 0 : (success * 100 / (success + failed));
}

<div class="dash container-fluid px-4 py-3">

    <!-- Header -->
    <div class="dash-head mb-3">
        <div class="dash-head__left">
            <div class="dash-avatar">üì¶</div>
            <div>
                <div class="dash-title">
                    Xin ch√†o <strong>@customer</strong>
                </div>
                <div class="dash-sub">
                    T·ªïng quan th·ªëng k√™ ƒë∆°n h√†ng theo th·ªùi gian l·ªçc
                    <span class="dash-dot"></span>
                    <span class="text-muted">C·∫≠p nh·∫≠t l√∫c <b>@lastUpdate</b></span>
                </div>
            </div>
        </div>

        <div class="dash-head__right">
            <div class="dash-pill">
                <span class="pill-dot"></span>
                <span>Dashboard</span>
            </div>
        </div>
    </div>

    <!-- KPI -->
    <div class="row g-3 mb-3">
        <div class="col-lg-4 col-md-4">
            <div class="kpi kpi-success h-100">
                <div class="kpi-top">
                    <div class="kpi-icon">‚úÖ</div>
                    <div>
                        <div class="kpi-label">Th√†nh c√¥ng</div>
                        <div class="kpi-value">@success</div>
                    </div>
                </div>
                <div class="kpi-foot">
                    <span>T·ªâ l·ªá th√†nh c√¥ng</span>
                    <span class="kpi-badge">@rate%</span>
                </div>
            </div>
        </div>

        <div class="col-lg-4 col-md-4">
            <div class="kpi kpi-danger h-100">
                <div class="kpi-top">
                    <div class="kpi-icon">‚Ü©Ô∏è</div>
                    <div>
                        <div class="kpi-label">ƒê√£ ho√†n</div>
                        <div class="kpi-value">@failed</div>
                    </div>
                </div>
                <div class="kpi-foot">
                    <span>S·ªë ƒë∆°n ho√†n trong kho·∫£ng l·ªçc</span>
                    <span class="kpi-badge">Return</span>
                </div>
            </div>
        </div>

        <div class="col-lg-4 col-md-4">
            <div class="kpi kpi-primary h-100">
                <div class="kpi-top">
                    <div class="kpi-icon">üìã</div>
                    <div>
                        <div class="kpi-label">T·ªïng ƒë∆°n</div>
                        <div class="kpi-value">@total</div>
                    </div>
                </div>
                <div class="kpi-foot">
                    <span>T·ªïng s·ªë ƒë∆°n ph√°t sinh</span>
                    <span class="kpi-badge">Total</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="row g-3">
        <!-- Bar -->
        <div class="col-lg-8">
            <div class="panel h-100">
                <div class="panel-head">
                    <div>
                        <div class="panel-title">
                            <i class="fas fa-chart-bar me-1"></i> TH·ªêNG K√ä ƒê∆†N H√ÄNG
                        </div>
                        <div class="panel-sub">Bi·ªÉu ƒë·ªì theo th√°ng (th√†nh c√¥ng / ho√†n / ƒëang giao / ch·ªù x·ª≠ l√Ω)</div>
                    </div>

                    <form method="get" class="dash-filter">
                        <div class="filter-group">
                            <label class="filter-label">T·ª´</label>
                            <input type="date" name="fromDate" class="form-control form-control-sm"
                                   value="@fromDate.ToString("yyyy-MM-dd")" />
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">ƒê·∫øn</label>
                            <input type="date" name="toDate" class="form-control form-control-sm"
                                   value="@toDate.ToString("yyyy-MM-dd")" />
                        </div>
                        <button class="btn btn-sm btn-outline-primary filter-btn" type="submit">
                            <i class="fas fa-filter me-1"></i> L·ªçc
                        </button>
                    </form>
                </div>

                <div class="panel-body">
                    <div class="mini-stats mb-2">
                        <div class="mini-item">
                            <div class="mini-label">Giao th√†nh c√¥ng</div>
                            <div class="mini-val text-success">
                                @success <span class="mini-muted">(@rate%)</span>
                            </div>
                        </div>
                        <div class="mini-item">
                            <div class="mini-label">ƒê√£ ho√†n</div>
                            <div class="mini-val text-danger">@failed</div>
                        </div>
                    </div>

                    <div class="chart-wrap">
                        <canvas id="barChart" height="120"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pie -->
        <div class="col-lg-4">
            <div class="panel h-100">
                <div class="panel-head">
                    <div>
                        <div class="panel-title">
                            <i class="fas fa-chart-pie me-1"></i> TOP 10 S·∫¢N L∆Ø·ª¢NG
                        </div>
                        <div class="panel-sub">Ph√¢n b·ªï theo t·ªânh/th√†nh</div>
                    </div>

                    <div class="panel-meta text-muted">
                        <i class="far fa-clock me-1"></i> @lastUpdate
                    </div>
                </div>

                <div class="panel-body">
                    <div class="pie-layout">
                        <div class="pie-canvas">
                            <canvas id="pieChart" height="220"></canvas>
                        </div>

                        <div class="pie-legend">
                            <div class="legend-title">Ch√∫ th√≠ch</div>
                            <ul id="pieLegend" class="list-unstyled mb-0"></ul>
                        </div>
                    </div>

                    <div class="hint mt-3">
                        G·ª£i √Ω: Danh s√°ch hi·ªÉn th·ªã t·ªëi ƒëa Top 10 ƒë·ªÉ d·ªÖ theo d√µi khu v·ª±c ƒë√≥ng g√≥p s·∫£n l∆∞·ª£ng.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // === BAR CHART ===
        const barData = @Html.Raw(JsonSerializer.Serialize(barData.ToList()));
        console.log("barData", barData);

        const barCtx = document.getElementById('barChart').getContext('2d');

        if (barData.length > 0) {
            new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: barData.map(b => b.month),      // "MM/yyyy"
                    datasets: [
                        {
                            label: 'Giao th√†nh c√¥ng',
                            data: barData.map(b => b.success),
                            backgroundColor: '#00a65a'
                        },
                        {
                            label: 'ƒê√£ ho√†n',
                            data: barData.map(b => b.fail),
                            backgroundColor: '#f56954'
                        },
                        {
                            label: 'ƒêang giao',
                            data: barData.map(b => b.shipping),
                            backgroundColor: '#00c0ef'
                        },
                        {
                            label: 'Ch·ªù x·ª≠ l√Ω',
                            data: barData.map(b => b.pending),
                            backgroundColor: '#f39c12'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'bottom' } },
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                }
            });
        }

        // === PIE CHART ===
        const pieData = @Html.Raw(JsonSerializer.Serialize(pieData.ToList()));
        console.log("pieData", pieData);

        if (pieData.length > 0) {
            const colors = [
                '#00c0ef','#f39c12','#00a65a','#f56954','#3c8dbc',
                '#ff6384','#36a2eb','#9966ff','#ff9f40','#d2d6de'
            ];

            const pieCtx = document.getElementById('pieChart').getContext('2d');
            new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: pieData.map(p => p.province),
                    datasets: [{
                        data: pieData.map(p => p.count),
                        backgroundColor: colors
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } }
                }
            });

            // Custom legend
            const legendContainer = document.getElementById('pieLegend');
            pieData.forEach((item, i) => {
                const li = document.createElement('li');
                li.className = "legend-item";
                li.innerHTML = `
                    <span class="legend-swatch" style="background:${colors[i % colors.length]}"></span>
                    <span class="legend-text">${item.province}</span>
                    <span class="legend-count">(${item.count})</span>
                `;
                legendContainer.appendChild(li);
            });
        }
    </script>
}

<style>
    /* ===== Base ===== */
    .dash {
        --bg: #ffffff;
        --text: #111827;
        --muted: #6b7280;
        --border: rgba(17, 24, 39, 0.10);
        --shadow: 0 10px 30px rgba(17, 24, 39, 0.08);
        --shadow2: 0 14px 40px rgba(17, 24, 39, 0.10);
        color: var(--text);
        font-family: "Segoe UI", system-ui, -apple-system, Arial, sans-serif;
    }

    /* ===== Header ===== */
    .dash-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 14px;
        padding: 14px 16px;
        border-radius: 16px;
        border: 1px solid var(--border);
        background: linear-gradient(180deg, rgba(13, 110, 253, 0.08), rgba(13, 110, 253, 0.02));
        box-shadow: var(--shadow);
    }

    .dash-head__left { display: flex; gap: 12px; align-items: center; }
    .dash-avatar {
        width: 44px; height: 44px; border-radius: 14px;
        display: grid; place-items: center;
        background: #fff; border: 1px solid var(--border);
        box-shadow: 0 8px 24px rgba(17, 24, 39, 0.08);
        font-size: 20px;
        flex: 0 0 auto;
    }

    .dash-title { font-weight: 900; letter-spacing: -0.2px; font-size: 1.15rem; }
    .dash-sub { margin-top: 4px; color: var(--muted); font-size: 0.95rem; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .dash-dot { width: 6px; height: 6px; border-radius: 99px; background: rgba(17,24,39,0.25); display: inline-block; }

    .dash-pill {
        display: inline-flex; align-items: center; gap: 10px;
        padding: 10px 12px; border-radius: 999px;
        border: 1px solid var(--border); background: #fff;
        box-shadow: 0 8px 18px rgba(17, 24, 39, 0.06);
        color: var(--muted); font-weight: 700; font-size: 0.9rem;
        user-select: none;
    }
    .pill-dot { width: 10px; height: 10px; border-radius: 99px; background: #22c55e; box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.18); }

    /* ===== KPI ===== */
    .kpi {
        border-radius: 18px;
        border: 1px solid var(--border);
        background: #fff;
        box-shadow: var(--shadow);
        padding: 14px 16px;
        transition: transform .18s ease, box-shadow .18s ease;
    }
    .kpi:hover { transform: translateY(-2px); box-shadow: var(--shadow2); }

    .kpi-top { display: flex; align-items: center; gap: 12px; }
    .kpi-icon {
        width: 44px; height: 44px; border-radius: 16px;
        display: grid; place-items: center;
        background: rgba(17,24,39,0.04);
        border: 1px solid var(--border);
        font-size: 18px;
        flex: 0 0 auto;
    }
    .kpi-label { color: var(--muted); font-weight: 800; font-size: 0.95rem; }
    .kpi-value { font-weight: 950; font-size: 1.6rem; letter-spacing: -0.4px; margin-top: 2px; }

    .kpi-foot {
        margin-top: 12px;
        padding-top: 10px;
        border-top: 1px dashed rgba(17,24,39,0.12);
        display: flex; align-items: center; justify-content: space-between;
        color: var(--muted); font-weight: 650; font-size: 0.92rem;
    }
    .kpi-badge {
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(17,24,39,0.03);
        color: #111827;
        font-weight: 800;
        font-size: 0.86rem;
    }

    .kpi-success { border-left: 6px solid rgba(40, 167, 69, 0.80); }
    .kpi-danger  { border-left: 6px solid rgba(220, 53, 69, 0.80); }
    .kpi-primary { border-left: 6px solid rgba(13, 110, 253, 0.80); }

    /* ===== Panel ===== */
    .panel {
        border-radius: 18px;
        border: 1px solid var(--border);
        background: #fff;
        box-shadow: var(--shadow);
        overflow: hidden;
        transition: transform .18s ease, box-shadow .18s ease;
    }
    .panel:hover { transform: translateY(-2px); box-shadow: var(--shadow2); }

    .panel-head {
        padding: 14px 16px;
        border-bottom: 1px solid rgba(17, 24, 39, 0.08);
        background: linear-gradient(180deg, rgba(17, 24, 39, 0.03), rgba(17, 24, 39, 0.01));
        display: flex; align-items: center; justify-content: space-between; gap: 12px;
        flex-wrap: wrap;
    }

    .panel-title { font-weight: 950; letter-spacing: -0.2px; }
    .panel-sub { color: var(--muted); font-size: 0.92rem; margin-top: 4px; }
    .panel-meta { font-weight: 700; font-size: 0.9rem; }

    .panel-body { padding: 14px 16px 16px 16px; }

    /* ===== Filter ===== */
    .dash-filter { display: flex; align-items: end; gap: 10px; flex-wrap: wrap; }
    .filter-group { display: grid; gap: 4px; }
    .filter-label { font-size: 0.78rem; color: var(--muted); font-weight: 800; }
    .filter-btn { white-space: nowrap; }

    /* ===== Mini stats ===== */
    .mini-stats {
        display: flex; gap: 12px; flex-wrap: wrap;
    }
    .mini-item {
        flex: 1 1 160px;
        border: 1px solid var(--border);
        background: rgba(17,24,39,0.02);
        border-radius: 14px;
        padding: 10px 12px;
    }
    .mini-label { color: var(--muted); font-weight: 800; font-size: 0.84rem; }
    .mini-val { font-weight: 950; font-size: 1.05rem; margin-top: 2px; }
    .mini-muted { color: var(--muted); font-weight: 800; }

    .chart-wrap {
        border: 1px solid rgba(17,24,39,0.08);
        border-radius: 16px;
        padding: 10px;
        background: #fff;
    }

    /* ===== Pie layout & legend ===== */
    .pie-layout { display: flex; gap: 12px; align-items: stretch; }
    .pie-canvas { flex: 1 1 auto; min-width: 0; }
    .pie-legend { width: 170px; border-left: 1px solid rgba(17,24,39,0.08); padding-left: 12px; }
    .legend-title { font-weight: 900; font-size: 0.92rem; margin-bottom: 8px; color: #111827; }

    #pieLegend { max-height: 220px; overflow-y: auto; padding-right: 6px; }
    #pieLegend li.legend-item {
        display: grid;
        grid-template-columns: 14px 1fr auto;
        gap: 8px;
        align-items: center;
        padding: 6px 0;
        border-bottom: 1px dashed rgba(17,24,39,0.10);
        font-size: 0.9rem;
    }
    #pieLegend li:last-child { border-bottom: 0; }
    .legend-swatch { width: 12px; height: 12px; border-radius: 4px; display: inline-block; border: 1px solid rgba(17,24,39,0.12); }
    .legend-text { color: #111827; font-weight: 650; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .legend-count { color: var(--muted); font-weight: 800; }

    .hint {
        font-size: 0.92rem;
        color: var(--muted);
        line-height: 1.5;
        border-left: 3px solid rgba(13, 110, 253, 0.35);
        padding-left: 10px;
    }

    /* IMPORTANT: Razor needs @@media */
    @@media (max-width: 992px) {
        .pie-layout { flex-direction: column; }
        .pie-legend { width: 100%; border-left: 0; border-top: 1px solid rgba(17,24,39,0.08); padding-left: 0; padding-top: 10px; }
    }
</style>
