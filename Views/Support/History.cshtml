@model List<SupportTicket>
@{
    Layout = "~/Views/Shared/_LayoutDriver.cshtml";
    ViewData["Title"] = "Nh·∫≠t k√Ω h·ªó tr·ª£";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />

<div class="support-history container-fluid py-4">
    <div class="wrap mx-auto">

        <!-- HERO -->
        <div class="hero mb-3">
            <div class="d-flex align-items-center gap-3">
                <div class="hero-ic"><i class="bi bi-journal-text"></i></div>
                <div>
                    <h2 class="m-0 hero-title">Nh·∫≠t k√Ω h·ªó tr·ª£</h2>
                    <div class="text-muted small">
                        L·ªãch s·ª≠ y√™u c·∫ßu & h·ªôi tho·∫°i v·ªõi b·ªô ph·∫≠n h·ªó tr·ª£
                    </div>
                </div>
            </div>

            <a href="/Support" class="btn btn-outline-dark btn-soft">
                <i class="bi bi-arrow-left me-1"></i> Quay l·∫°i
            </a>
        </div>

        <!-- ALERTS -->
        @if (TempData["Success"] != null)
        {
            <div class="alert alert-success rounded-4 shadow-sm border-0">
                <i class="bi bi-check-circle-fill me-2"></i>@TempData["Success"]
            </div>
        }
        @if (TempData["Error"] != null)
        {
            <div class="alert alert-danger rounded-4 shadow-sm border-0">
                <i class="bi bi-exclamation-circle-fill me-2"></i>@TempData["Error"]
            </div>
        }

        @if (!Model.Any())
        {
            <div class="empty">
                <div class="empty-ic">üì≠</div>
                <div class="fw-bold">B·∫°n ch∆∞a g·ª≠i y√™u c·∫ßu h·ªó tr·ª£ n√†o</div>
                <div class="text-muted">Khi c√≥ s·ª± c·ªë, h√£y g·ª≠i h·ªó tr·ª£ ƒë·ªÉ ƒë∆∞·ª£c x·ª≠ l√Ω nhanh.</div>
            </div>
        }
        else
        {
            <div class="tickets">
                @foreach (var t in Model.OrderByDescending(x => x.CreatedAt))
                {
                    bool isPending = t.Status == "pending";

                    <div class="ticket-card mb-3">
                        <!-- HEADER -->
                        <div class="ticket-head">
                            <div class="text-muted small">
                                <i class="bi bi-clock me-1"></i>
                                @t.CreatedAt.ToString("dd/MM/yyyy HH:mm")
                            </div>

                            @if (isPending)
                            {
                                <span class="badge badge-warn">
                                    <i class="bi bi-hourglass-split me-1"></i> Ch·ªù ph·∫£n h·ªìi
                                </span>
                            }
                            else
                            {
                                <span class="badge badge-ok">
                                    <i class="bi bi-check-circle me-1"></i> ƒê√£ ph·∫£n h·ªìi
                                </span>
                            }
                        </div>

                        <!-- DRIVER MESSAGE -->
                        <div class="bubble bubble-driver">
                            <div class="bubble-label">B·∫°n</div>
                            <div class="bubble-content">
                                @t.Message
                            </div>
                        </div>

                        <!-- ADMIN REPLY -->
                        @if (!string.IsNullOrEmpty(t.Reply))
                        {
                            <div class="bubble bubble-admin">
                                <div class="bubble-label">H·ªó tr·ª£</div>
                                <div class="bubble-content" style="white-space:pre-line;">
                                    @t.Reply
                                </div>
                                <div class="bubble-time">
                                    <i class="bi bi-calendar-check me-1"></i>
                                    @t.RepliedAt?.ToString("dd/MM/yyyy HH:mm")
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="text-muted fst-italic small mt-2">
                                <i class="bi bi-chat-left-dots me-1"></i> Ch∆∞a c√≥ ph·∫£n h·ªìi t·ª´ h·ªó tr·ª£
                            </div>
                        }

                        <!-- DRIVER REPLY -->
                        <form asp-action="AddReply" asp-controller="Support" method="post" class="reply-form mt-3">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@t.Id" />

                            <div class="input-group">
                                <input type="text"
                                       name="replyText"
                                       class="form-control input-soft"
                                       placeholder="Nh·∫Øn th√™m cho b·ªô ph·∫≠n h·ªó tr·ª£..." />
                                <button class="btn btn-primary btn-soft">
                                    <i class="bi bi-send-fill"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                }
            </div>
        }
    </div>
</div>

<style>
    .support-history{
        --border: rgba(17,24,39,.12);
        --shadow: 0 10px 30px rgba(17,24,39,.08);
        font-family: "Segoe UI", system-ui, -apple-system, Arial, sans-serif;
    }
    .wrap{ max-width: 880px; }

    /* HERO */
    .hero{
        padding: 16px 18px;
        border-radius: 18px;
        border: 1px solid var(--border);
        background: linear-gradient(180deg, rgba(13,110,253,.12), rgba(13,110,253,.02));
        box-shadow: var(--shadow);
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap: 14px;
        flex-wrap: wrap;
    }
    .hero-ic{
        width:46px;height:46px;border-radius:16px;
        display:grid;place-items:center;
        background:#fff;border:1px solid var(--border);
        box-shadow:0 8px 24px rgba(17,24,39,.08);
        font-size:20px;color:#0d6efd;
    }
    .hero-title{
        font-weight:950;
        text-transform:uppercase;
        letter-spacing:-.2px;
        color:#0d6efd;
        font-size:1.2rem;
    }

    /* EMPTY */
    .empty{
        text-align:center;
        padding:28px 16px;
        border-radius:18px;
        border:1px dashed rgba(17,24,39,.18);
        background:rgba(17,24,39,.02);
        box-shadow:var(--shadow);
    }
    .empty-ic{ font-size:38px;margin-bottom:6px; }

    /* TICKET */
    .ticket-card{
        border-radius:18px;
        border:1px solid var(--border);
        background:#fff;
        box-shadow:var(--shadow);
        padding:16px;
    }
    .ticket-head{
        display:flex;
        justify-content:space-between;
        align-items:center;
        margin-bottom:10px;
    }

    /* BADGES */
    .badge{
        border-radius:999px;
        padding:7px 12px;
        font-weight:900;
        font-size:.85rem;
    }
    .badge-warn{ background:rgba(255,193,7,.18);color:#664d03; }
    .badge-ok{ background:rgba(25,135,84,.16);color:#0f5132; }

    /* CHAT BUBBLES */
    .bubble{
        max-width:92%;
        margin-bottom:10px;
    }
    .bubble-driver{ margin-left:auto;text-align:right; }
    .bubble-admin{ margin-right:auto; }

    .bubble-label{
        font-size:.8rem;
        font-weight:800;
        color:#6b7280;
        margin-bottom:2px;
    }
    .bubble-content{
        padding:12px 14px;
        border-radius:16px;
        box-shadow:0 6px 16px rgba(17,24,39,.08);
    }
    .bubble-driver .bubble-content{
        background:#0d6efd;
        color:#fff;
        border-bottom-right-radius:4px;
    }
    .bubble-admin .bubble-content{
        background:#f8f9fa;
        color:#111827;
        border-bottom-left-radius:4px;
    }
    .bubble-time{
        font-size:.75rem;
        color:#6b7280;
        margin-top:4px;
    }

    /* FORM */
    .input-soft{
        border-radius:14px;
        border:1px solid rgba(17,24,39,.15);
    }
    .btn-soft{ border-radius:14px;font-weight:900; }

    @@media(max-width:576px){
        .bubble{ max-width:100%; }
    }
</style>
