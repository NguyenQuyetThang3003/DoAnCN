@using System.Text.Json
@model WedNightFury.Controllers.AdminReportOverviewViewModel

@{
    ViewData["Title"] = "B√°o c√°o & Th·ªëng k√™";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";

    var dayLabels  = Model.OrdersPerDay.Select(x => x.Date.ToString("dd/MM")).ToList();
    var dayCounts  = Model.OrdersPerDay.Select(x => x.Count).ToList();

    var areaLabels = Model.AreaStats.Select(x => x.Province).ToList();
    var areaCounts = Model.AreaStats.Select(x => x.Count).ToList();

    var ratingLabels = Model.RatingStats.Select(x => $"{x.Score}‚òÖ").ToList();
    var ratingCounts = Model.RatingStats.Select(x => x.Count).ToList();
}

<style>
    /* ===== Match your Dashboard style (dash) ===== */
    .dash {
        --text: #111827;
        --muted: #6b7280;
        --border: rgba(17, 24, 39, 0.10);
        --shadow: 0 10px 30px rgba(17, 24, 39, 0.08);
        --shadow2: 0 14px 40px rgba(17, 24, 39, 0.10);
        font-family: "Segoe UI", system-ui, -apple-system, Arial, sans-serif;
        color: var(--text);
    }

    /* ===== Header ===== */
    .dash-head{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:14px;
        padding:14px 16px;
        border-radius:16px;
        border:1px solid var(--border);
        background: linear-gradient(180deg, rgba(13,110,253,.08), rgba(13,110,253,.02));
        box-shadow: var(--shadow);
        margin: 12px 0 14px;
        flex-wrap: wrap;
    }
    .dash-left{display:flex;gap:12px;align-items:center;}
    .dash-avatar{
        width:44px;height:44px;border-radius:14px;
        display:grid;place-items:center;
        background:#fff;border:1px solid var(--border);
        box-shadow:0 8px 24px rgba(17,24,39,.08);
        font-size:20px;
        flex:0 0 auto;
    }
    .dash-title{font-weight:950;letter-spacing:-.2px;margin:0;}
    .dash-sub{
        color:var(--muted);
        font-size:.95rem;
        margin-top:4px;
        display:flex;
        gap:10px;
        align-items:center;
        flex-wrap:wrap;
    }
    .dash-dot{width:6px;height:6px;border-radius:99px;background:rgba(17,24,39,0.25);display:inline-block;}

    .dash-pill{
        display:inline-flex;align-items:center;gap:10px;
        padding:10px 12px;border-radius:999px;
        border:1px solid var(--border);background:#fff;
        box-shadow:0 8px 18px rgba(17,24,39,.06);
        color: var(--muted);
        font-weight:950;
        font-size:.9rem;
        user-select:none;
        white-space:nowrap;
    }
    .pill-dot{width:10px;height:10px;border-radius:99px;background:#22c55e;box-shadow:0 0 0 4px rgba(34,197,94,0.18);}

    /* ===== KPI ===== */
    .kpi{
        border-radius:18px;
        border:1px solid var(--border);
        background:#fff;
        box-shadow: var(--shadow);
        padding:14px 16px;
        transition: transform .18s ease, box-shadow .18s ease;
        height:100%;
    }
    .kpi:hover{transform:translateY(-2px);box-shadow: var(--shadow2);}

    .kpi-top{display:flex;align-items:center;gap:12px;justify-content:space-between;}
    .kpi-left{display:flex;align-items:center;gap:12px;}
    .kpi-icon{
        width:44px;height:44px;border-radius:16px;
        display:grid;place-items:center;
        background: rgba(17,24,39,0.04);
        border: 1px solid var(--border);
        font-size:18px;
        flex:0 0 auto;
    }
    .kpi-label{color:var(--muted);font-weight:900;font-size:.92rem;}
    .kpi-value{font-weight:950;font-size:1.6rem;letter-spacing:-.4px;margin-top:2px;}
    .kpi-foot{
        margin-top:12px;
        padding-top:10px;
        border-top:1px dashed rgba(17,24,39,0.12);
        display:flex;align-items:center;justify-content:space-between;gap:10px;
        color:var(--muted);
        font-weight:800;
        font-size:.88rem;
        flex-wrap:wrap;
    }
    .kpi-badge{
        padding:6px 10px;border-radius:999px;
        border:1px solid var(--border);
        background: rgba(17,24,39,0.03);
        color:#111827;
        font-weight:900;
        font-size:.86rem;
        white-space:nowrap;
    }
    .kpi-primary{border-left:6px solid rgba(13,110,253,.80);}
    .kpi-success{border-left:6px solid rgba(40,167,69,.80);}
    .kpi-danger{border-left:6px solid rgba(220,53,69,.80);}
    .kpi-warning{border-left:6px solid rgba(255,193,7,.85);}

    /* ===== Panel ===== */
    .panel{
        border-radius:18px;
        border:1px solid var(--border);
        background:#fff;
        box-shadow: var(--shadow);
        overflow:hidden;
        transition: transform .18s ease, box-shadow .18s ease;
        height:100%;
    }
    .panel:hover{transform:translateY(-2px);box-shadow: var(--shadow2);}
    .panel-head{
        padding:14px 16px;
        border-bottom: 1px solid rgba(17, 24, 39, 0.08);
        background: linear-gradient(180deg, rgba(17, 24, 39, 0.03), rgba(17, 24, 39, 0.01));
        display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
    }
    .panel-title{font-weight:950;letter-spacing:-.2px;}
    .panel-sub{color:var(--muted);font-size:.92rem;margin-top:4px;}
    .panel-body{padding:14px 16px 16px 16px;}

    /* ===== Filter ===== */
    .dash-filter{display:flex;align-items:end;gap:10px;flex-wrap:wrap;}
    .filter-group{display:grid;gap:4px;}
    .filter-label{font-size:.78rem;color:var(--muted);font-weight:900;}
    .filter-btn{white-space:nowrap;border-radius:999px !important;font-weight:900;padding:.55rem .95rem;}

    .btn-pill{border-radius:999px !important;font-weight:900;padding:.55rem .95rem;white-space:nowrap;}
    .btn-ghost{
        border-radius:999px !important;
        font-weight:900;
        padding:.55rem .95rem;
        background:#fff;
        border:1px solid rgba(17,24,39,0.14);
        color:#111827;
        text-decoration:none;
    }

    /* ===== Tables ===== */
    .table-clean thead th{
        background:#f8f9fa !important;
        font-weight:950;
        color:#495057;
        border-bottom: 1px solid rgba(17,24,39,0.10) !important;
        white-space:nowrap;
    }
    .table-clean td, .table-clean th{
        padding:.8rem .9rem;
        vertical-align:middle;
        border-color: rgba(17,24,39,0.06);
    }
    .table-clean tbody tr:hover{background: rgba(13,110,253,.04);}

    /* ===== Chart wrap ===== */
    .chart-wrap{
        border:1px solid rgba(17,24,39,0.08);
        border-radius:16px;
        padding:10px;
        background:#fff;
    }

    @@media (max-width: 992px){
        .dash-head{align-items:flex-start;}
    }
</style>

<div class="dash container-fluid py-3">

    <!-- Header -->
    <div class="dash-head">
        <div class="dash-left">
            <div class="dash-avatar">üìä</div>
            <div>
                <h2 class="dash-title">B√°o c√°o & Th·ªëng k√™</h2>
                <div class="dash-sub">
                    T·ªïng h·ª£p theo kho·∫£ng th·ªùi gian l·ªçc
                    <span class="dash-dot"></span>
                    <span class="text-muted">
                        @Model.FromDate.ToString("dd/MM/yyyy") - @Model.ToDate.ToString("dd/MM/yyyy")
                    </span>
                </div>
            </div>
        </div>

        <div class="dash-pill">
            <span class="pill-dot"></span>
            <span>Reports</span>
        </div>
    </div>

    <!-- Filter panel -->
    <div class="panel mb-3">
        <div class="panel-head">
            <div>
                <div class="panel-title"><i class="fas fa-filter me-1"></i> B·ªô l·ªçc ng√†y</div>
                <div class="panel-sub">Ch·ªçn kho·∫£ng th·ªùi gian ƒë·ªÉ xem th·ªëng k√™ v√† xu·∫•t CSV.</div>
            </div>

            <form asp-action="Overview" asp-controller="AdminReports" method="get" class="dash-filter">
                <div class="filter-group">
                    <label class="filter-label">T·ª´ ng√†y</label>
                    <input type="date" name="from" class="form-control form-control-sm"
                           value="@Model.FromDate.ToString("yyyy-MM-dd")" />
                </div>
                <div class="filter-group">
                    <label class="filter-label">ƒê·∫øn ng√†y</label>
                    <input type="date" name="to" class="form-control form-control-sm"
                           value="@Model.ToDate.ToString("yyyy-MM-dd")" />
                </div>

                <button type="submit" class="btn btn-primary btn-pill">
                    <i class="fas fa-search me-1"></i> Xem b√°o c√°o
                </button>

                <button type="submit"
                        formaction="@Url.Action("ExportOrders", "AdminReports")"
                        class="btn btn-success btn-pill">
                    <i class="fas fa-file-export me-1"></i> Xu·∫•t Excel (CSV)
                </button>
            </form>
        </div>

        <div class="panel-body">
            <div class="text-muted small">
                Kho·∫£ng th·ªùi gian hi·ªán t·∫°i:
                <b>@Model.FromDate.ToString("dd/MM/yyyy")</b> ‚Äì <b>@Model.ToDate.ToString("dd/MM/yyyy")</b>
            </div>
        </div>
    </div>

    <!-- KPI row 1 -->
    <div class="row g-3 mb-3">
        <div class="col-lg-3 col-md-6">
            <div class="kpi kpi-primary">
                <div class="kpi-top">
                    <div class="kpi-left">
                        <div class="kpi-icon">üì¶</div>
                        <div>
                            <div class="kpi-label">T·ªïng s·ªë ƒë∆°n</div>
                            <div class="kpi-value">@Model.TotalOrders</div>
                        </div>
                    </div>
                </div>
                <div class="kpi-foot">
                    <span>Pending: <b>@Model.PendingOrders</b> | Shipping: <b>@Model.ShippingOrders</b></span>
                    <span class="kpi-badge">Total</span>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="kpi kpi-success">
                <div class="kpi-top">
                    <div class="kpi-left">
                        <div class="kpi-icon">‚úÖ</div>
                        <div>
                            <div class="kpi-label">ƒê∆°n th√†nh c√¥ng</div>
                            <div class="kpi-value text-success">@Model.DoneOrders</div>
                        </div>
                    </div>
                </div>
                <div class="kpi-foot">
                    <span>Th·∫•t b·∫°i: <b>@Model.FailedOrders</b></span>
                    <span class="kpi-badge">Done</span>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="kpi kpi-warning">
                <div class="kpi-top">
                    <div class="kpi-left">
                        <div class="kpi-icon">üéØ</div>
                        <div>
                            <div class="kpi-label">T·ª∑ l·ªá giao th√†nh c√¥ng</div>
                            <div class="kpi-value">@Model.SuccessRate %</div>
                        </div>
                    </div>
                </div>
                <div class="kpi-foot">
                    <span>Trong c√°c ƒë∆°n ƒë√£ x·ª≠ l√Ω</span>
                    <span class="kpi-badge">Rate</span>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="kpi kpi-primary">
                <div class="kpi-top">
                    <div class="kpi-left">
                        <div class="kpi-icon">üí∞</div>
                        <div>
                            <div class="kpi-label">Doanh thu (COD + ship)</div>
                            <div class="kpi-value text-primary">@Model.TotalRevenue.ToString("N0") ƒë</div>
                        </div>
                    </div>
                </div>
                <div class="kpi-foot">
                    <span>Ship: <b>@Model.TotalShipFee.ToString("N0") ƒë</b> | COD: <b>@Model.TotalCod.ToString("N0") ƒë</b></span>
                    <span class="kpi-badge">Revenue</span>
                </div>
            </div>
        </div>
    </div>

    <!-- KPI row 2 -->
    <div class="row g-3 mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="kpi kpi-primary">
                <div class="kpi-top">
                    <div class="kpi-left">
                        <div class="kpi-icon">üë•</div>
                        <div>
                            <div class="kpi-label">S·ªë kh√°ch h√†ng</div>
                            <div class="kpi-value">@Model.TotalCustomers</div>
                        </div>
                    </div>
                </div>
                <div class="kpi-foot">
                    <span>Trong kho·∫£ng th·ªùi gian ch·ªçn</span>
                    <span class="kpi-badge">Customers</span>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="kpi kpi-warning">
                <div class="kpi-top">
                    <div class="kpi-left">
                        <div class="kpi-icon">‚≠ê</div>
                        <div>
                            <div class="kpi-label">ƒêi·ªÉm ƒë√°nh gi√° TB</div>
                            <div class="kpi-value text-warning">@Model.AverageRating</div>
                        </div>
                    </div>
                </div>
                <div class="kpi-foot">
                    <span>T·ª´ 1 ƒë·∫øn 5 sao</span>
                    <span class="kpi-badge">Rating</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="row g-3 mb-4">
        <div class="col-lg-6">
            <div class="panel">
                <div class="panel-head">
                    <div>
                        <div class="panel-title"><i class="fas fa-chart-line me-1"></i> S·ªë ƒë∆°n theo ng√†y</div>
                        <div class="panel-sub">Di·ªÖn bi·∫øn s·ªë ƒë∆°n ph√°t sinh theo t·ª´ng ng√†y.</div>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="chart-wrap">
                        <canvas id="ordersPerDayChart" height="140"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="panel">
                <div class="panel-head">
                    <div>
                        <div class="panel-title"><i class="fas fa-chart-bar me-1"></i> ƒê∆°n theo khu v·ª±c (Top 10)</div>
                        <div class="panel-sub">Ph√¢n b·ªï theo t·ªânh/th√†nh ƒë·ªÉ nh√¨n nhanh khu v·ª±c ƒë√≥ng g√≥p.</div>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="chart-wrap">
                        <canvas id="areaChart" height="140"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tables + rating -->
    <div class="row g-3">
        <div class="col-lg-6">
            <div class="panel">
                <div class="panel-head">
                    <div>
                        <div class="panel-title"><i class="fas fa-bolt me-1"></i> Hi·ªáu su·∫•t t√†i x·∫ø (Top 5)</div>
                        <div class="panel-sub">S·ªë ƒë∆°n th√†nh c√¥ng v√† rating trung b√¨nh theo t√†i x·∫ø.</div>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="table-responsive">
                        <table class="table table-clean table-hover table-sm mb-0">
                            <thead>
                                <tr>
                                    <th>T√†i x·∫ø</th>
                                    <th class="text-end">ƒê∆°n th√†nh c√¥ng</th>
                                    <th class="text-end">Rating TB</th>
                                </tr>
                            </thead>
                            <tbody>
                            @if (Model.DriverStats.Any())
                            {
                                foreach (var d in Model.DriverStats)
                                {
                                    <tr>
                                        <td class="fw-semibold">@d.DriverName (#@d.DriverId)</td>
                                        <td class="text-end fw-bold">@d.TotalDone</td>
                                        <td class="text-end">@d.AvgRating</td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="3" class="text-center text-muted py-3">
                                        Ch∆∞a c√≥ d·ªØ li·ªáu.
                                    </td>
                                </tr>
                            }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="panel">
                <div class="panel-head">
                    <div>
                        <div class="panel-title"><i class="fas fa-star me-1"></i> Ph√¢n b·ªë ƒëi·ªÉm ƒë√°nh gi√°</div>
                        <div class="panel-sub">Bi·ªÉu ƒë·ªì v√† b·∫£ng t·ªïng h·ª£p theo s·ªë sao.</div>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="chart-wrap mb-3">
                        <canvas id="ratingChart" height="140"></canvas>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-clean table-sm mb-0">
                            <thead>
                                <tr>
                                    <th>ƒêi·ªÉm</th>
                                    <th class="text-end">S·ªë l∆∞·ª£t</th>
                                </tr>
                            </thead>
                            <tbody>
                            @foreach (var r in Model.RatingStats)
                            {
                                <tr>
                                    <td class="fw-semibold">@r.Score ‚òÖ</td>
                                    <td class="text-end fw-bold">@r.Count</td>
                                </tr>
                            }
                            </tbody>
                        </table>
                    </div>

                </div>
            </div>
        </div>
    </div>

</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const dayLabels    = @Html.Raw(JsonSerializer.Serialize(dayLabels));
        const dayCounts    = @Html.Raw(JsonSerializer.Serialize(dayCounts));

        const areaLabels   = @Html.Raw(JsonSerializer.Serialize(areaLabels));
        const areaCounts   = @Html.Raw(JsonSerializer.Serialize(areaCounts));

        const ratingLabels = @Html.Raw(JsonSerializer.Serialize(ratingLabels));
        const ratingCounts = @Html.Raw(JsonSerializer.Serialize(ratingCounts));

        // Line: Orders per day
        const ctxDay = document.getElementById('ordersPerDayChart');
        if (ctxDay && dayLabels.length > 0) {
            new Chart(ctxDay, {
                type: 'line',
                data: {
                    labels: dayLabels,
                    datasets: [{
                        label: 'S·ªë ƒë∆°n',
                        data: dayCounts,
                        tension: 0.3,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { title: { display: true, text: 'Ng√†y' } },
                        y: {
                            title: { display: true, text: 'S·ªë ƒë∆°n' },
                            beginAtZero: true,
                            ticks: { precision: 0 }
                        }
                    }
                }
            });
        }

        // Bar: Orders by area
        const ctxArea = document.getElementById('areaChart');
        if (ctxArea && areaLabels.length > 0) {
            new Chart(ctxArea, {
                type: 'bar',
                data: {
                    labels: areaLabels,
                    datasets: [{
                        label: 'S·ªë ƒë∆°n',
                        data: areaCounts
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { title: { display: true, text: 'Khu v·ª±c' } },
                        y: {
                            title: { display: true, text: 'S·ªë ƒë∆°n' },
                            beginAtZero: true,
                            ticks: { precision: 0 }
                        }
                    }
                }
            });
        }

        // Bar: Rating distribution
        const ctxRating = document.getElementById('ratingChart');
        if (ctxRating && ratingLabels.length > 0) {
            new Chart(ctxRating, {
                type: 'bar',
                data: {
                    labels: ratingLabels,
                    datasets: [{
                        label: 'S·ªë l∆∞·ª£t',
                        data: ratingCounts
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { title: { display: true, text: 'ƒêi·ªÉm' } },
                        y: {
                            title: { display: true, text: 'S·ªë l∆∞·ª£t' },
                            beginAtZero: true,
                            ticks: { precision: 0 }
                        }
                    }
                }
            });
        }
    </script>
}
