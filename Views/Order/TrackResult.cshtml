@using System.Linq
@using System.Text.RegularExpressions
@model IEnumerable<WedNightFury.Models.Order>

@{
    Layout = "~/Views/Shared/_LayoutPublic.cshtml";
    ViewData["Title"] = "K·∫øt qu·∫£ tra c·ª©u";

    var list = Model?.ToList() ?? new List<WedNightFury.Models.Order>();

    string MaskPhone(string? s)
    {
        if (string.IsNullOrWhiteSpace(s)) return "-";
        var digits = Regex.Replace(s, @"\D", "");
        if (digits.Length <= 4) return digits;
        if (digits.Length <= 7) return digits.Substring(0, 3) + "****";
        return digits.Substring(0, 3) + "****" + digits.Substring(digits.Length - 3);
    }

    (string text, string badge, string dot) MapStatus(string? st)
    {
        var s = (st ?? "").Trim().ToLowerInvariant();
        return s switch
        {
            "pending"   => ("Ch·ªù ti·∫øp nh·∫≠n",   "bg-warning text-dark", "dot-warn"),
            "assigned"  => ("ƒê√£ ph√¢n c√¥ng",    "bg-secondary",        "dot-gray"),
            "shipping"  => ("ƒêang giao",       "bg-primary",          "dot-blue"),
            "done"      => ("Giao th√†nh c√¥ng", "bg-success",          "dot-green"),
            "failed"    => ("Giao th·∫•t b·∫°i",   "bg-danger",           "dot-red"),
            "cancelled" => ("ƒê√£ h·ªßy",          "bg-dark",             "dot-dark"),
            _           => ("Kh√¥ng r√µ",        "bg-light text-dark",   "dot-light")
        };
    }

    string Money(decimal v) => v.ToString("N0") + " ƒë";
}

<div class="track-result container py-4" style="max-width: 1040px;">

    <!-- Header -->
    <div class="tr-head d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
        <div class="min-w-0">
            <div class="d-flex align-items-center gap-2">
                <div class="tr-ic">üîé</div>
                <div>
                    <h3 class="fw-bold mb-1">K·∫øt qu·∫£ tra c·ª©u</h3>
                    <div class="text-muted">
                        T√¨m th·∫•y <span class="fw-bold">@list.Count</span> ƒë∆°n ph√π h·ª£p.
                    </div>
                </div>
            </div>
        </div>

        <a class="btn btn-outline-dark tr-btn"
           href="@Url.Action("Track","Order")">
            <i class="bi bi-arrow-left me-1"></i> Tra c·ª©u l·∫°i
        </a>
    </div>

    @if (!list.Any())
    {
        <div class="tr-empty card border-0 shadow-sm rounded-4">
            <div class="card-body p-4 text-center">
                <div class="empty-ic mb-2">üì≠</div>
                <div class="fw-bold fs-5 mb-1">Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng n√†o</div>
                <div class="text-muted mb-3">Vui l√≤ng ki·ªÉm tra l·∫°i m√£ ƒë∆°n ho·∫∑c s·ªë ƒëi·ªán tho·∫°i.</div>
                <a class="btn btn-primary tr-btn"
                   href="@Url.Action("Track","Order")">
                    Tra c·ª©u l·∫°i
                </a>
            </div>
        </div>
    }
    else
    {
        <!-- Table -->
        <div class="tr-card card border-0 shadow-sm rounded-4">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table tr-table align-middle m-0">
                        <thead>
                            <tr>
                                <th style="width:190px;">M√£ ƒë∆°n</th>
                                <th style="min-width:220px;">Ng∆∞·ªùi nh·∫≠n</th>
                                <th>ƒê·ªãa ch·ªâ</th>
                                <th style="width:150px;" class="text-end">COD</th>
                                <th style="width:190px;">Tr·∫°ng th√°i</th>
                                <th style="width:190px;">C·∫≠p nh·∫≠t</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var o in list)
                            {
                                var ms = MapStatus(o.Status);

                                // N·∫øu CreatedAt l√† DateTime (kh√¥ng nullable) th√¨ lastTime s·∫Ω lu√¥n c√≥.
                                // N·∫øu CreatedAt l√† DateTime? th√¨ v·∫´n an to√†n v√¨ d√πng ?.ToString
                                var lastTime = o.DeliveredAt ?? o.FailedAt ?? o.AssignedAt ?? o.CreatedAt;

                                <tr>
                                    <td>
                                        <div class="fw-bold text-primary">@o.Code</div>
                                        <div class="small text-muted">#@o.Id</div>
                                    </td>

                                    <td>
                                        <div class="fw-semibold">@o.ReceiverName</div>
                                        <div class="small text-muted">@MaskPhone(o.ReceiverPhone)</div>
                                    </td>

                                    <td class="text-muted">
                                        <div class="text-truncate-2">@o.ReceiverAddress</div>
                                    </td>

                                    <td class="text-end">
                                        @if (o.CodAmount > 0)
                                        {
                                            <span class="cod-pill">@Money(o.CodAmount)</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">0 ƒë</span>
                                        }
                                    </td>

                                    <td>
                                        <span class="badge tr-badge @ms.badge px-3 py-2 rounded-pill">
                                            <span class="tr-dot @ms.dot"></span>
                                            @ms.text
                                        </span>
                                    </td>

                                    <td class="text-muted">
                                        @(lastTime?.ToString("dd/MM/yyyy HH:mm") ?? "-")
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <div class="px-3 py-3 tr-foot text-muted small">
                    L∆∞u √Ω: M·ªôt s·ªë th√¥ng tin c√° nh√¢n (SƒêT) ƒë∆∞·ª£c ·∫©n b·ªõt ƒë·ªÉ b·∫£o m·∫≠t.
                </div>
            </div>
        </div>
    }
</div>

<style>
    .track-result{
        --border: rgba(17,24,39,.12);
        --shadow: 0 10px 30px rgba(17,24,39,.08);
        --soft: rgba(17,24,39,.04);
        font-family: "Segoe UI", system-ui, -apple-system, Arial, sans-serif;
    }

    /* Header */
    .tr-head{ }
    .tr-ic{
        width:46px;height:46px;border-radius:16px;
        display:grid;place-items:center;
        background:#fff;border:1px solid var(--border);
        box-shadow: 0 8px 22px rgba(17,24,39,.08);
        flex:0 0 auto;
    }
    .tr-btn{ border-radius: 12px; font-weight: 800; }

    /* Card/Table */
    .tr-card{
        overflow:hidden;
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
    }
    .tr-table thead th{
        background: #f8fafc;
        border-bottom: 1px solid rgba(17,24,39,.08);
        font-weight: 900;
        color:#111827;
        white-space: nowrap;
        padding: 14px 14px;
    }
    .tr-table tbody td{
        padding: 14px 14px;
        border-top: 1px solid rgba(17,24,39,.06);
        vertical-align: middle;
    }
    .tr-table tbody tr:hover{
        background: rgba(220,53,69,.03);
    }

    .text-truncate-2{
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    /* Status badge */
    .tr-badge{
        font-size: .9rem;
        font-weight: 900;
        border: 1px solid rgba(17,24,39,.10);
        display:inline-flex;
        align-items:center;
        gap: 8px;
        white-space: nowrap;
    }
    .tr-dot{
        width:10px;height:10px;border-radius:99px;
        display:inline-block;
        box-shadow: 0 0 0 4px rgba(17,24,39,.06);
    }
    .dot-warn{ background:#f59e0b; box-shadow:0 0 0 4px rgba(245,158,11,.18); }
    .dot-gray{ background:#6b7280; box-shadow:0 0 0 4px rgba(107,114,128,.16); }
    .dot-blue{ background:#0d6efd; box-shadow:0 0 0 4px rgba(13,110,253,.18); }
    .dot-green{ background:#22c55e; box-shadow:0 0 0 4px rgba(34,197,94,.18); }
    .dot-red{ background:#ef4444; box-shadow:0 0 0 4px rgba(239,68,68,.18); }
    .dot-dark{ background:#111827; box-shadow:0 0 0 4px rgba(17,24,39,.12); }
    .dot-light{ background:#cbd5e1; box-shadow:0 0 0 4px rgba(203,213,225,.20); }

    /* COD */
    .cod-pill{
        display:inline-block;
        padding: 6px 10px;
        border-radius: 999px;
        background: rgba(25,135,84,.10);
        border: 1px solid rgba(25,135,84,.20);
        color:#0f5132;
        font-weight: 900;
        white-space: nowrap;
    }

    /* Empty */
    .tr-empty{
        border: 1px dashed rgba(17,24,39,.16);
        box-shadow: var(--shadow);
    }
    .empty-ic{ font-size: 42px; }

    /* Footer */
    .tr-foot{
        background: linear-gradient(180deg, rgba(17,24,39,.02), rgba(17,24,39,.01));
        border-top: 1px solid rgba(17,24,39,.06);
    }

    @@media (max-width: 576px){
        .tr-table thead{ display:none; }
        .tr-table tbody td{ display:block; }
        .tr-table tbody tr{ display:block; padding: 8px 0; }
        .tr-table tbody td{ border-top:none; padding: 8px 14px; }
    }
</style>
