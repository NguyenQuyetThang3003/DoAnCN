@using WedNightFury.Models
@using WedNightFury.Controllers
@model WedNightFury.Controllers.AdminOrderListViewModel

@{
    ViewData["Title"] = "ƒê∆°n m·ªõi / Ch·ªù ph√¢n c√¥ng";
    Layout = "_LayoutAdmin";

    var drivers = ViewBag.Drivers as List<User> ?? new List<User>();
    var hubs = ViewBag.Hubs as List<HubOptionVm> ?? new List<HubOptionVm>();

    // Hub l·ªçc (HandlingHubId)
    int? filterHubId = Model.HubId;
}

<style>
    /* ===== Match your Dashboard style (dash) ===== */
    .dash {
        --text: #111827;
        --muted: #6b7280;
        --border: rgba(17, 24, 39, 0.10);
        --shadow: 0 10px 30px rgba(17, 24, 39, 0.08);
        --shadow2: 0 14px 40px rgba(17, 24, 39, 0.10);
        font-family: "Segoe UI", system-ui, -apple-system, Arial, sans-serif;
        color: var(--text);
    }

    /* ===== Header like dashboard ===== */
    .dash-head{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:14px;
        padding:14px 16px;
        border-radius:16px;
        border:1px solid var(--border);
        background: linear-gradient(180deg, rgba(13,110,253,.08), rgba(13,110,253,.02));
        box-shadow: var(--shadow);
        margin-bottom: 14px;
        flex-wrap: wrap;
    }
    .dash-left{display:flex;gap:12px;align-items:center;}
    .dash-avatar{
        width:44px;height:44px;border-radius:14px;
        display:grid;place-items:center;
        background:#fff;border:1px solid var(--border);
        box-shadow:0 8px 24px rgba(17, 24, 39, 0.08);
        font-size:20px;
        flex:0 0 auto;
    }
    .dash-title{font-weight:900;letter-spacing:-.2px;margin:0;}
    .dash-sub{
        color:var(--muted);
        font-size:.95rem;
        margin-top:4px;
        display:flex;
        gap:10px;
        align-items:center;
        flex-wrap:wrap;
    }
    .dash-dot{width:6px;height:6px;border-radius:99px;background:rgba(17,24,39,0.25);display:inline-block;}

    .dash-pill{
        display:inline-flex;align-items:center;gap:10px;
        padding:10px 12px;border-radius:999px;
        border:1px solid var(--border);background:#fff;
        box-shadow:0 8px 18px rgba(17, 24, 39, 0.06);
        color: var(--muted);
        font-weight:900;
        font-size:.9rem;
        user-select:none;
        text-decoration:none;
        white-space:nowrap;
    }
    .pill-dot{
        width:10px;height:10px;border-radius:99px;
        background:#22c55e;
        box-shadow:0 0 0 4px rgba(34,197,94,0.18);
    }

    /* ===== Toast-like alerts ===== */
    .notice{
        border-radius: 16px;
        border: 1px solid var(--border);
        box-shadow: 0 8px 18px rgba(17,24,39,.06);
        padding: 10px 12px;
        display:flex;
        gap:10px;
        align-items:flex-start;
        margin-bottom: 10px;
        background:#fff;
    }
    .notice .ic{
        width:34px;height:34px;border-radius:14px;
        display:grid;place-items:center;
        border: 1px solid var(--border);
        background:#fff;
        flex:0 0 auto;
    }
    .notice .title{font-weight:950;margin:0;}
    .notice .msg{margin:2px 0 0;color:var(--muted);}
    .notice-danger{background: linear-gradient(180deg, rgba(220,53,69,.08), rgba(255,255,255,1)); border-color: rgba(220,53,69,.22);}
    .notice-success{background: linear-gradient(180deg, rgba(25,135,84,.08), rgba(255,255,255,1)); border-color: rgba(25,135,84,.22);}
    .notice-warning{background: linear-gradient(180deg, rgba(255,193,7,.12), rgba(255,255,255,1)); border-color: rgba(255,193,7,.28);}

    /* ===== Panel ===== */
    .panel{
        border-radius:18px;
        border:1px solid var(--border);
        background:#fff;
        box-shadow: var(--shadow);
        overflow:hidden;
        transition: transform .18s ease, box-shadow .18s ease;
    }
    .panel:hover{transform:translateY(-2px);box-shadow:var(--shadow2);}

    .panel-head{
        padding:14px 16px;
        border-bottom: 1px solid rgba(17, 24, 39, 0.08);
        background: linear-gradient(180deg, rgba(17, 24, 39, 0.03), rgba(17, 24, 39, 0.01));
        display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
    }
    .panel-title{font-weight:950;letter-spacing:-.2px;}
    .panel-sub{color:var(--muted);font-size:.92rem;margin-top:4px;}
    .panel-body{padding:14px 16px 16px 16px;}

    /* ===== Filter bar ===== */
    .filter-grid{
        display:grid;
        grid-template-columns: 1.2fr .8fr .8fr 1.2fr .7fr;
        gap: 10px;
        align-items:end;
    }
    .filter-actions{
        display:flex;
        justify-content:flex-end;
        gap:10px;
        flex-wrap:wrap;
        margin-top:10px;
    }
    .form-label{font-weight:900;color:var(--text);font-size:.92rem;}
    .form-control, .form-select{
        border-radius:12px;
        padding:.55rem .75rem;
        border-color: rgba(17,24,39,0.12);
    }
    .form-control:focus, .form-select:focus{
        box-shadow: 0 0 0 .2rem rgba(13,110,253,.12);
        border-color: rgba(13,110,253,.35);
    }
    .btn-pill{
        border-radius:999px !important;
        font-weight:900;
        padding:.55rem .95rem;
        white-space:nowrap;
    }
    .btn-ghost{
        border-radius:999px !important;
        font-weight:900;
        padding:.55rem .95rem;
        background:#fff;
        border: 1px solid rgba(17,24,39,0.14);
    }
    .help-text{color:var(--muted);font-size:.9rem;margin-top:6px;}

    /* ===== Assignment block ===== */
    .assign-grid{
        display:grid;
        grid-template-columns: 1fr 1.35fr .8fr;
        gap: 12px;
        align-items:end;
    }
    .soft-box{
        border:1px solid rgba(17,24,39,0.10);
        background: rgba(17,24,39,0.02);
        border-radius: 16px;
        padding: 12px;
    }
    .warn-inline{
        border-radius: 14px;
        padding: 10px 12px;
        border: 1px solid rgba(245,158,11,0.28);
        background: rgba(245,158,11,0.08);
        color:#92400e;
        font-weight:700;
        font-size:.92rem;
    }

    /* ===== Table ===== */
    .table-clean{margin:0;}
    .table-clean thead th{
        background: rgba(17,24,39,0.03) !important;
        font-weight:950;
        color: var(--text);
        border-bottom: 1px solid rgba(17,24,39,0.10) !important;
        white-space: nowrap;
    }
    .table-clean td, .table-clean th{
        padding:.85rem .95rem;
        vertical-align:middle;
        border-color: rgba(17,24,39,0.06);
    }
    .table-clean tbody tr{transition: background .12s ease;}
    .table-clean tbody tr:hover{background: rgba(13,110,253,.04);}
    .truncate{
        max-width: 260px;
        overflow:hidden;
        text-overflow:ellipsis;
        white-space:nowrap;
    }

    /* ===== Selected count ===== */
    .count-pill{
        display:inline-flex;
        align-items:center;
        gap:8px;
        padding:8px 10px;
        border-radius:999px;
        border: 1px solid var(--border);
        background:#fff;
        box-shadow:0 8px 18px rgba(17,24,39,.06);
        color: var(--muted);
        font-weight:900;
        font-size:.9rem;
        white-space:nowrap;
    }
    .count-badge{
        display:inline-flex;
        min-width:26px;
        height:26px;
        border-radius:999px;
        align-items:center;
        justify-content:center;
        background: rgba(13,110,253,.10);
        color:#0d6efd;
        font-weight:950;
    }

    /* ===== Action buttons in table ===== */
    .btn-group .btn{
        border-radius:999px !important;
        font-weight:900;
        padding:.35rem .75rem;
    }
    .btn-group .btn + .btn{ margin-left: 6px; }

    /* ===== Responsive ===== */
    @@media (max-width: 992px){
        .filter-grid{grid-template-columns: 1fr 1fr; }
        .assign-grid{grid-template-columns: 1fr; }
    }
</style>

<div class="dash container-fluid py-3">

    <!-- Header -->
    <div class="dash-head">
        <div class="dash-left">
            <div class="dash-avatar">üì¶</div>
            <div>
                <h2 class="dash-title">ƒê∆°n m·ªõi / Ch·ªù ph√¢n c√¥ng</h2>
                <div class="dash-sub">
                    L·ªçc ƒë∆°n theo keyword / th·ªùi gian / hub ph·ª• tr√°ch v√† ph√¢n c√¥ng nhanh
                    <span class="dash-dot"></span>
                    <span class="text-muted">ƒêang hi·ªÉn th·ªã: <b>@(Model.Items?.Count() ?? 0)</b> ƒë∆°n</span>
                </div>
            </div>
        </div>

        <a asp-action="Index" class="dash-pill">
            <span class="pill-dot"></span>
            <span><i class="fas fa-list me-1"></i> T·∫•t c·∫£ ƒë∆°n</span>
        </a>
    </div>

    <!-- Notices -->
    @if (TempData["Error"] != null)
    {
        <div class="notice notice-danger">
            <div class="ic">‚õî</div>
            <div>
                <p class="title mb-0">C√≥ l·ªói</p>
                <p class="msg mb-0">@TempData["Error"]</p>
            </div>
        </div>
    }
    @if (TempData["Success"] != null)
    {
        <div class="notice notice-success">
            <div class="ic">‚úÖ</div>
            <div>
                <p class="title mb-0">Th√†nh c√¥ng</p>
                <p class="msg mb-0">@TempData["Success"]</p>
            </div>
        </div>
    }
    @if (TempData["Warning"] != null)
    {
        <div class="notice notice-warning">
            <div class="ic">‚ö†Ô∏è</div>
            <div>
                <p class="title mb-0">L∆∞u √Ω</p>
                <p class="msg mb-0">@TempData["Warning"]</p>
            </div>
        </div>
    }

    <!-- Filter panel (GET) -->
    <div class="panel mb-3">
        <div class="panel-head">
            <div>
                <div class="panel-title"><i class="fas fa-filter me-1"></i> B·ªô l·ªçc</div>
                <div class="panel-sub">L·ªçc theo m√£ ƒë∆°n/ng∆∞·ªùi g·ª≠i/ng∆∞·ªùi nh·∫≠n, th·ªùi gian v√† Hub ph·ª• tr√°ch (HandlingHubId).</div>
            </div>

            <div class="d-flex gap-2 flex-wrap">
                <a asp-action="NewOrders" class="btn btn-outline-secondary btn-pill">
                    <i class="fas fa-eraser me-1"></i> B·ªè l·ªçc
                </a>
                <a asp-action="Index" class="btn btn-outline-secondary btn-pill">
                    <i class="fas fa-list me-1"></i> Xem t·∫•t c·∫£
                </a>
            </div>
        </div>

        <div class="panel-body">
            <form method="get">
                <div class="filter-grid">
                    <div>
                        <label class="form-label">T·ª´ kh√≥a</label>
                        <input type="text" name="keyword" value="@Model.Keyword" class="form-control"
                               placeholder="M√£ ƒë∆°n / ng∆∞·ªùi g·ª≠i / ng∆∞·ªùi nh·∫≠n..." />
                    </div>

                    <div>
                        <label class="form-label">T·ª´ ng√†y</label>
                        <input type="date" name="fromDate" value="@(Model.FromDate?.ToString("yyyy-MM-dd"))" class="form-control" />
                    </div>

                    <div>
                        <label class="form-label">ƒê·∫øn ng√†y</label>
                        <input type="date" name="toDate" value="@(Model.ToDate?.ToString("yyyy-MM-dd"))" class="form-control" />
                    </div>

                    <div>
                        <label class="form-label">Hub ph·ª• tr√°ch</label>
                        <select id="hubFilterSelect" name="hubId" class="form-select">
                            <option value="">-- L·ªçc theo Hub ph·ª• tr√°ch --</option>
                            @foreach (var h in hubs)
                            {
                                var label = string.IsNullOrWhiteSpace(h.Address) ? h.Name : $"{h.Name} - {h.Address}";
                                if (filterHubId.HasValue && filterHubId.Value == h.Id)
                                {
                                    <option value="@h.Id" selected="selected">@label</option>
                                }
                                else
                                {
                                    <option value="@h.Id">@label</option>
                                }
                            }
                        </select>
                        <div class="help-text">Ch·ªâ hi·ªÉn th·ªã ƒë∆°n c√≥ <b>HandlingHubId</b> = hub ƒë√£ ch·ªçn.</div>
                    </div>

                    <div>
                        <button type="submit" class="btn btn-primary btn-pill w-100">
                            <i class="fas fa-filter me-1"></i> L·ªçc
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    @if (Model.Items == null || !Model.Items.Any())
    {
        <div class="panel">
            <div class="panel-body">
                <div class="warn-inline">
                    Hi·ªán kh√¥ng c√≥ ƒë∆°n n√†o ƒëang ch·ªù ph√¢n c√¥ng.
                </div>
            </div>
        </div>
    }
    else
    {
        <!-- POST assign form -->
        <form id="assignRouteForm"
              asp-action="PreviewAssignRoute"
              asp-controller="AdminOrders"
              method="post"
              asp-antiforgery="true">

            @Html.AntiForgeryToken()

            <!-- Assign panel -->
            <div class="panel mb-3">
                <div class="panel-head">
                    <div>
                        <div class="panel-title"><i class="fas fa-route me-1"></i> Ph√¢n c√¥ng & t·ªëi ∆∞u tuy·∫øn</div>
                        <div class="panel-sub">Ch·ªçn t√†i x·∫ø, hub xu·∫•t ph√°t v√† c√°c ƒë∆°n c·∫ßn t·ªëi ∆∞u tuy·∫øn.</div>
                    </div>

                    <div class="count-pill">
                        <span>ƒê√£ ch·ªçn</span>
                        <span class="count-badge" id="selectedCount">0</span>
                        <span class="text-muted">ƒë∆°n</span>
                    </div>
                </div>

                <div class="panel-body">
                    <div class="assign-grid">
                        <!-- Driver -->
                        <div class="soft-box">
                            <label class="form-label">Ch·ªçn t√†i x·∫ø</label>
                            <select id="driverSelect" name="driverId" class="form-select" required>
                                <option value="">-- Ch·ªçn t√†i x·∫ø --</option>
                                @foreach (var d in drivers)
                                {
                                    var name = string.IsNullOrWhiteSpace(d.UserName) ? $"T√†i x·∫ø #{d.Id}" : d.UserName;
                                    <option value="@d.Id">@name</option>
                                }
                            </select>
                            <div class="text-danger small mt-2 d-none" id="driverWarn">
                                Vui l√≤ng ch·ªçn t√†i x·∫ø.
                            </div>
                        </div>

                        <!-- Origin hub / fallback -->
                        <div class="soft-box">
                            <label class="form-label">ƒêi·ªÉm xu·∫•t ph√°t (Hub l·∫•y h√†ng)</label>

                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="useFilterAsOrigin"
                                       @(filterHubId.HasValue ? "checked" : "") />
                                <label class="form-check-label" for="useFilterAsOrigin">
                                    D√πng Hub ƒëang l·ªçc l√†m ƒëi·ªÉm xu·∫•t ph√°t
                                </label>
                            </div>

                            <select id="hubOriginSelect" name="hubId" class="form-select">
                                <option value="">-- Ch·ªçn hub l√†m ƒëi·ªÉm xu·∫•t ph√°t --</option>
                                @foreach (var h in hubs)
                                {
                                    var label = string.IsNullOrWhiteSpace(h.Address) ? h.Name : $"{h.Name} - {h.Address}";
                                    if (filterHubId.HasValue && filterHubId.Value == h.Id)
                                    {
                                        <option value="@h.Id" selected="selected">@label</option>
                                    }
                                    else
                                    {
                                        <option value="@h.Id">@label</option>
                                    }
                                }
                            </select>

                            <div class="help-text">
                                N·∫øu b·∫≠t ‚ÄúD√πng Hub ƒëang l·ªçc‚Ä¶‚Äù, Hub xu·∫•t ph√°t s·∫Ω t·ª± b√°m theo Hub l·ªçc ƒë·ªÉ tr√°nh nh·∫ßm.
                            </div>

                            <div class="text-warning small mt-1 d-none" id="hubMismatchWarn">
                                ‚ö†Ô∏è B·∫°n ƒëang ch·ªçn Hub xu·∫•t ph√°t kh√°c Hub ƒëang l·ªçc.
                            </div>

                            <div class="mt-2">
                                <button type="button" class="btn btn-outline-secondary btn-pill" id="toggleManualOrigin">
                                    <i class="fas fa-keyboard me-1"></i> Nh·∫≠p th·ªß c√¥ng ƒë·ªãa ch·ªâ xu·∫•t ph√°t (fallback)
                                </button>
                            </div>

                            <div id="manualOriginWrap" class="mt-2 d-none">
                                <input type="text" name="driverOriginAddress" class="form-control"
                                       placeholder="VD: 595 Nguy·ªÖn Tri Ph∆∞∆°ng, Th·ªß ƒê·ª©c, TP.HCM ho·∫∑c lat,lng"
                                       autocomplete="street-address" />
                                <small class="text-muted">
                                    N·∫øu ƒë√£ ch·ªçn Hub th√¨ h·ªá th·ªëng ∆∞u ti√™n Hub, field n√†y ch·ªâ d√πng khi kh√¥ng ch·ªçn Hub.
                                </small>
                            </div>
                        </div>

                        <!-- Optimize button -->
                        <div class="soft-box">
                            <button id="btnOptimize" type="submit" class="btn btn-primary btn-pill w-100" disabled>
                                <i class="fas fa-wand-magic-sparkles me-1"></i> T·ªëi ∆∞u tuy·∫øn & ph√¢n c√¥ng
                            </button>

                            <div class="text-danger small mt-2 d-none" id="selectWarn">
                                Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 ƒë∆°n ƒë·ªÉ t·ªëi ∆∞u tuy·∫øn.
                            </div>

                            <div class="help-text mt-2">
                                G·ª£i √Ω: d√πng ‚ÄúCh·ªçn t·∫•t c·∫£‚Äù ƒë·ªÉ ph√¢n c√¥ng nhanh khi ƒë∆°n c√πng Hub ph·ª• tr√°ch.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Orders table panel -->
            <div class="panel">
                <div class="panel-head">
                    <div>
                        <div class="panel-title"><i class="fas fa-inbox me-1"></i> Danh s√°ch ƒë∆°n ch·ªù ph√¢n c√¥ng</div>
                        <div class="panel-sub">Ch·ªçn c√°c ƒë∆°n c·∫ßn t·ªëi ∆∞u tuy·∫øn ho·∫∑c g√°n l·∫ª t·ª´ng ƒë∆°n.</div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-clean table-hover mb-0 align-middle">
                        <thead>
                            <tr>
                                <th style="width:40px;"><input id="selectAll" type="checkbox" /></th>
                                <th>M√£ ƒë∆°n</th>
                                <th>Kh√°ch h√†ng</th>
                                <th>Ng∆∞·ªùi nh·∫≠n</th>
                                <th>SƒêT nh·∫≠n</th>
                                <th>ƒê·ªãa ch·ªâ nh·∫≠n</th>
                                <th>Th√†nh ph·ªë</th>
                                <th class="text-end">Ti·ªÅn COD</th>
                                <th class="text-end">Ph√≠ ship</th>
                                <th>Ng√†y t·∫°o</th>
                                <th style="width:140px;" class="text-end">Thao t√°c</th>
                            </tr>
                        </thead>

                        <tbody>
                        @foreach (var o in Model.Items)
                        {
                            <tr>
                                <td>
                                    <input class="order-checkbox" type="checkbox" name="orderIds" value="@o.Id" />
                                </td>
                                <td class="fw-bold">@o.Code</td>
                                <td>@o.CustomerName</td>
                                <td>@o.ReceiverName</td>
                                <td>@o.ReceiverPhone</td>
                                <td class="truncate">@o.ReceiverAddress</td>
                                <td>@o.Province</td>
                                <td class="text-end fw-bold">@o.CodAmount.ToString("N0")</td>
                                <td class="text-end">@o.ShipFee.ToString("N0")</td>
                                <td class="text-nowrap">@(o.CreatedAt?.ToString("dd/MM/yyyy HH:mm"))</td>

                                <td class="text-end">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="submit"
                                                class="btn btn-outline-secondary"
                                                data-mode="single"
                                                formaction="@Url.Action("AssignDriverSimple", "AdminOrders")"
                                                formmethod="post"
                                                name="orderId"
                                                value="@o.Id"
                                                onclick="return confirmAssignSingle();">
                                            <i class="fas fa-user-check me-1"></i> G√°n l·∫ª
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            </div>
        </form>

        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const form = document.getElementById("assignRouteForm");
                const btnOptimize = document.getElementById("btnOptimize");
                const selectWarn = document.getElementById("selectWarn");
                const driverWarn = document.getElementById("driverWarn");
                const countEl = document.getElementById("selectedCount");
                const selectAll = document.getElementById("selectAll");
                const driverSelect = document.getElementById("driverSelect");

                const btnToggle = document.getElementById("toggleManualOrigin");
                const manualWrap = document.getElementById("manualOriginWrap");

                const hubFilter = document.getElementById("hubFilterSelect");
                const hubOrigin = document.getElementById("hubOriginSelect");
                const useFilterAsOrigin = document.getElementById("useFilterAsOrigin");
                const hubMismatchWarn = document.getElementById("hubMismatchWarn");

                function getOrderCheckboxes() {
                    return Array.from(document.querySelectorAll(".order-checkbox"));
                }

                function syncOriginWithFilterIfNeeded() {
                    if (!hubOrigin) return;

                    const filterVal = hubFilter ? hubFilter.value : "";
                    const originVal = hubOrigin.value;

                    if (useFilterAsOrigin && useFilterAsOrigin.checked) {
                        if (filterVal) hubOrigin.value = filterVal;
                        hubOrigin.disabled = true;
                    } else {
                        hubOrigin.disabled = false;
                    }

                    const shouldWarn = !!filterVal && !!hubOrigin.value && (hubOrigin.value !== filterVal);
                    if (hubMismatchWarn) hubMismatchWarn.classList.toggle("d-none", !shouldWarn);
                }

                function updateUI() {
                    const cbs = getOrderCheckboxes();
                    const checked = cbs.filter(x => x.checked).length;

                    countEl.textContent = checked.toString();

                    const hasDriver = !!(driverSelect && driverSelect.value);
                    btnOptimize.disabled = !(checked > 0 && hasDriver);

                    selectWarn.classList.toggle("d-none", checked !== 0);
                    driverWarn.classList.toggle("d-none", hasDriver);

                    if (checked === 0) selectAll.checked = false;
                    else selectAll.checked = (checked === cbs.length);

                    syncOriginWithFilterIfNeeded();
                }

                if (selectAll) {
                    selectAll.addEventListener("change", function () {
                        const cbs = getOrderCheckboxes();
                        cbs.forEach(cb => cb.checked = selectAll.checked);
                        updateUI();
                    });
                }

                getOrderCheckboxes().forEach(cb => cb.addEventListener("change", updateUI));
                if (driverSelect) driverSelect.addEventListener("change", updateUI);

                if (useFilterAsOrigin) useFilterAsOrigin.addEventListener("change", updateUI);
                if (hubOrigin) hubOrigin.addEventListener("change", updateUI);

                if (form) {
                    form.addEventListener("submit", function (e) {
                        const submitter = e.submitter;
                        const mode = submitter?.getAttribute("data-mode");

                        const hasDriver = !!(driverSelect && driverSelect.value);
                        const checked = getOrderCheckboxes().filter(x => x.checked).length;

                        if (mode === "single") {
                            if (!hasDriver) {
                                e.preventDefault();
                                updateUI();
                                alert("Vui l√≤ng ch·ªçn t√†i x·∫ø tr∆∞·ªõc khi g√°n l·∫ª.");
                            }
                            return;
                        }

                        if (checked === 0 || !hasDriver) {
                            e.preventDefault();
                            updateUI();
                            window.scrollTo({ top: 0, behavior: "smooth" });
                            return;
                        }
                    });
                }

                if (btnToggle && manualWrap) {
                    btnToggle.addEventListener("click", function () {
                        manualWrap.classList.toggle("d-none");
                    });
                }

                if (hubOrigin && manualWrap) {
                    hubOrigin.addEventListener("change", function () {
                        if (hubOrigin.value && !manualWrap.classList.contains("d-none")) {
                            manualWrap.classList.add("d-none");
                        }
                    });
                }

                updateUI();
            });

            function confirmAssignSingle() {
                const driverSelect = document.getElementById("driverSelect");
                if (!driverSelect || !driverSelect.value) {
                    alert("Vui l√≤ng ch·ªçn t√†i x·∫ø tr∆∞·ªõc khi g√°n l·∫ª.");
                    return false;
                }
                return confirm("X√°c nh·∫≠n g√°n ƒë∆°n n√†y cho t√†i x·∫ø ƒë√£ ch·ªçn?");
            }
        </script>
    }
</div>
