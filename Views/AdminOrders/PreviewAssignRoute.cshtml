@using WedNightFury.Controllers
@model WedNightFury.Controllers.AdminRoutePreviewViewModel

@{
    ViewData["Title"] = "Xem tuy·∫øn t·ªëi ∆∞u & ph√¢n c√¥ng";
    Layout = "_LayoutAdmin";

    var orders = (Model.Orders ?? new List<AdminRouteOrderItemViewModel>())
        .OrderBy(o => o.Sequence)
        .ToList();

    var hasHub = Model.HubId.HasValue && Model.HubId.Value > 0;
    var hubText = hasHub
        ? (string.IsNullOrWhiteSpace(Model.HubAddress) ? (Model.HubName ?? "Hub") : $"{Model.HubName} - {Model.HubAddress}")
        : "";

    var hasManualOrigin = !string.IsNullOrWhiteSpace(Model.DriverOriginAddress);
    var originQuery = (Model.DriverOriginQuery ?? "").Trim();
    var hasOriginQuery = !string.IsNullOrWhiteSpace(originQuery);

    bool MissingCoord(AdminRouteOrderItemViewModel o) => !o.Lat.HasValue || !o.Lng.HasValue;
    var missingCount = orders.Count(MissingCoord);
}

<h3 class="fw-bold text-primary mb-3">
    XEM TUY·∫æN T·ªêI ∆ØU &amp; PH√ÇN C√îNG
    <small class="text-muted">
        ‚Äì @Model.DriverName (@Model.DeliveryDate.ToString("dd/MM/yyyy"))
    </small>
</h3>

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}
@if (TempData["Success"] != null)
{
    <div class="alert alert-success">@TempData["Success"]</div>
}
@if (TempData["Warning"] != null)
{
    <div class="alert alert-warning">@TempData["Warning"]</div>
}

@if (!orders.Any())
{
    <div class="alert alert-warning">
        Kh√¥ng c√≥ ƒë∆°n n√†o trong tuy·∫øn ƒë·ªÉ ph√¢n c√¥ng.
    </div>
}
else
{
    <div class="row">
        <!-- LEFT: LIST + CONFIRM -->
        <div class="col-md-6">
            <div class="card shadow-sm mb-3">
                <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                    <span>Danh s√°ch ƒëi·ªÉm giao (c√≥ th·ªÉ ch·ªânh th·ª© t·ª±)</span>
                    @if (missingCount > 0)
                    {
                        <span class="badge bg-warning text-dark">
                            @missingCount ƒë∆°n thi·∫øu Lat/Lng
                        </span>
                    }
                </div>

                <div class="card-body">
                    <div class="mb-2">
                        <div class="small text-muted">ƒêi·ªÉm xu·∫•t ph√°t</div>

                        <div class="fw-semibold">
                            @if (hasHub)
                            {
                                <span class="badge bg-primary me-2">Hub</span>
                                @hubText
                            }
                            else if (hasManualOrigin)
                            {
                                <span class="badge bg-secondary me-2">Nh·∫≠p tay</span>
                                @Model.DriverOriginAddress
                            }
                            else
                            {
                                <span class="text-muted">
                                    (Kh√¥ng ch·ªçn Hub / kh√¥ng nh·∫≠p ‚Äì Google Maps s·∫Ω d√πng ƒëi·ªÉm giao ƒë·∫ßu ti√™n l√†m ƒëi·ªÉm xu·∫•t ph√°t)
                                </span>
                            }
                        </div>

                        @if (hasOriginQuery)
                        {
                            <div class="small text-muted mt-1">
                                Query d√πng ƒë·ªÉ t·∫°o Google Maps: <code>@originQuery</code>
                            </div>
                        }
                    </div>

                    <div class="small text-muted">
                        Tip: N·∫øu tuy·∫øn t·ªëi ∆∞u ‚Äúl·∫°‚Äù th∆∞·ªùng do thi·∫øu Lat/Lng ho·∫∑c Lat/Lng sai.
                        B·∫°n c√≥ th·ªÉ ch·ªânh Sequence th·ªß c√¥ng r·ªìi b·∫•m X√°c nh·∫≠n.
                    </div>
                </div>

                <div class="card-body p-0">
                    <table class="table table-striped table-hover mb-0 align-middle" id="routeTable">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 90px;">Seq</th>
                                <th style="width: 160px;">M√£ ƒë∆°n</th>
                                <th>ƒê·ªãa ch·ªâ nh·∫≠n</th>
                                <th style="width: 170px;">Lat/Lng</th>
                                <th style="width: 70px;">‚Üë‚Üì</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (int i = 0; i < orders.Count; i++)
                            {
                                var o = orders[i];
                                var missing = MissingCoord(o);

                                <tr data-row="@i">
                                    <td>
                                        <!-- ‚úÖ cho s·ª≠a sequence tr·ª±c ti·∫øp -->
                                        <input type="number"
                                               class="form-control form-control-sm seq-input"
                                               min="1"
                                               value="@o.Sequence"
                                               data-orderid="@o.OrderId" />
                                    </td>

                                    <td class="fw-semibold">@o.Code</td>

                                    <td>
                                        @o.ReceiverAddress
                                        @if (missing)
                                        {
                                            <span class="badge bg-warning text-dark ms-2">Thi·∫øu Lat/Lng</span>
                                        }
                                    </td>

                                    <td class="small text-muted">
                                        @if (!missing)
                                        {
                                            <span>@o.Lat.Value.ToString("0.######"), @o.Lng.Value.ToString("0.######")</span>
                                        }
                                        else
                                        {
                                            <span>-</span>
                                        }
                                    </td>

                                    <td>
                                        <div class="d-flex gap-1">
                                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="moveRowUp(this)">‚Üë</button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="moveRowDown(this)">‚Üì</button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <div class="card-body">
                    <div class="d-flex gap-2 flex-wrap">
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="normalizeSequence()">
                            Chu·∫©n ho√° Seq (1..n)
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="rebuildMapsLinkHint()">
                            Nh·∫Øc c·∫≠p nh·∫≠t Google Maps
                        </button>
                    </div>
                    <small class="text-muted d-block mt-2">
                        Khi b·∫°n ch·ªânh th·ª© t·ª±, link Google Maps ƒëang hi·ªÉn th·ªã c√≥ th·ªÉ ch∆∞a kh·ªõp 100%.
                        B·∫°n n√™n b·∫•m ‚ÄúM·ªü tuy·∫øn‚Äù l·∫°i sau khi X√°c nh·∫≠n, ho·∫∑c quay l·∫°i Preview l·∫ßn n·ªØa.
                    </small>
                </div>
            </div>

            <!-- CONFIRM FORM -->
            <form asp-action="ConfirmAssignRoute"
                  asp-controller="AdminOrders"
                  method="post"
                  id="confirmForm">
                @Html.AntiForgeryToken()

                <input type="hidden" name="DriverId" value="@Model.DriverId" />
                <input type="hidden" name="DeliveryDate" value="@Model.DeliveryDate.ToString("yyyy-MM-dd")" />

                <!-- Hub -->
                <input type="hidden" name="HubId" value="@(Model.HubId ?? 0)" />
                <input type="hidden" name="DriverOriginAddress" value="@(Model.DriverOriginAddress ?? "")" />
                <input type="hidden" name="DriverOriginQuery" value="@(Model.DriverOriginQuery ?? "")" />

                <!-- ‚úÖ container hidden Orders[i] s·∫Ω ƒë∆∞·ª£c build t·ª´ JS theo b·∫£ng hi·ªán t·∫°i -->
                <div id="ordersHiddenContainer"></div>

                <div class="d-flex justify-content-between mt-2">
                    <a asp-action="NewOrders" class="btn btn-secondary">
                        Quay l·∫°i danh s√°ch ƒë∆°n
                    </a>
                    <button type="submit" class="btn btn-success">
                        ‚úî X√°c nh·∫≠n ph√¢n c√¥ng &amp; l∆∞u tuy·∫øn
                    </button>
                </div>

                <small class="text-muted d-block mt-2">
                    Khi x√°c nh·∫≠n, h·ªá th·ªëng s·∫Ω l∆∞u <strong>DriverId</strong> + <strong>DeliveryDate</strong> + <strong>Sequence</strong> cho t·ª´ng ƒë∆°n.
                </small>
            </form>
        </div>

        <!-- RIGHT: GOOGLE MAPS -->
        <div class="col-md-6">
            <div class="card shadow-sm mb-3">
                <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                    <span>Tuy·∫øn ƒë∆∞·ªùng tr√™n Google Maps</span>
                    @if (!string.IsNullOrWhiteSpace(Model.GoogleMapsUrl))
                    {
                        <span class="badge bg-info text-dark">Theo Seq hi·ªán t·∫°i (t·ª´ server)</span>
                    }
                </div>

                <div class="card-body">
                    @if (string.IsNullOrWhiteSpace(Model.GoogleMapsUrl))
                    {
                        <div class="alert alert-info mb-0">
                            Ch∆∞a t·∫°o ƒë∆∞·ª£c tuy·∫øn tr√™n Google Maps v√¨ thi·∫øu ƒë·ªãa ch·ªâ/t·ªça ƒë·ªô h·ª£p l·ªá.<br />
                            Vui l√≤ng ki·ªÉm tra l·∫°i <strong>ƒë·ªãa ch·ªâ ng∆∞·ªùi nh·∫≠n</strong> ho·∫∑c <strong>Lat/Lng</strong>.
                        </div>
                    }
                    else
                    {
                        <p class="mb-2">
                            Tuy·∫øn ƒë∆∞·ª£c t·∫°o theo <strong>Sequence</strong> ·ªü b·∫£ng b√™n tr√°i (t·ª´ server).
                            N·∫øu b·∫°n v·ª´a ch·ªânh Seq th·ªß c√¥ng, h√£y <strong>X√°c nh·∫≠n</strong> tr∆∞·ªõc r·ªìi m·ªü l·∫°i tuy·∫øn.
                        </p>

                        <div class="d-flex gap-2 flex-wrap">
                            <a class="btn btn-primary"
                               href="@Model.GoogleMapsUrl"
                               target="_blank"
                               rel="noopener">
                                üó∫ M·ªü tuy·∫øn tr√™n Google Maps
                            </a>

                            <button type="button" class="btn btn-outline-secondary" onclick="copyMapsUrl()">
                                üìã Copy link
                            </button>
                        </div>

                        <small class="text-muted d-block mt-2">
                            Tr√™n Google Maps:
                            ƒëi·ªÉm <strong>A</strong> = ƒëi·ªÉm xu·∫•t ph√°t (Hub ho·∫∑c nh·∫≠p tay n·∫øu c√≥),
                            ƒëi·ªÉm <strong>B</strong> = ƒëi·ªÉm cu·ªëi,
                            c√°c ƒëi·ªÉm ·ªü gi·ªØa = c√°c ƒëi·ªÉm giao c√≤n l·∫°i.
                        </small>

                        <textarea id="mapsUrlBox" class="form-control mt-2" rows="4" readonly>@Model.GoogleMapsUrl</textarea>

                        <div class="alert alert-warning mt-3 mb-0 d-none" id="mapsHint">
                            B·∫°n v·ª´a thay ƒë·ªïi th·ª© t·ª± Seq. Link Google Maps hi·ªán t·∫°i c√≥ th·ªÉ ch∆∞a kh·ªõp.
                            H√£y b·∫•m <strong>X√°c nh·∫≠n</strong> ƒë·ªÉ l∆∞u Seq m·ªõi, r·ªìi m·ªü l·∫°i tuy·∫øn.
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <script>
        function copyMapsUrl() {
            const box = document.getElementById('mapsUrlBox');
            if (!box) return;

            const text = box.value || box.textContent || "";
            if (!text) return;

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text)
                    .then(() => alert("ƒê√£ copy link Google Maps!"))
                    .catch(() => fallbackCopy(text));
            } else {
                fallbackCopy(text);
            }
        }

        function fallbackCopy(text) {
            const temp = document.createElement("textarea");
            temp.value = text;
            document.body.appendChild(temp);
            temp.select();
            try { document.execCommand("copy"); } catch (e) { }
            document.body.removeChild(temp);
            alert("ƒê√£ copy link Google Maps!");
        }

        function rebuildHiddenOrders() {
            const container = document.getElementById("ordersHiddenContainer");
            const rows = Array.from(document.querySelectorAll("#routeTable tbody tr"));

            // l·∫•y seq t·ª´ input, sort theo seq tƒÉng d·∫ßn ƒë·ªÉ submit chu·∫©n
            const items = rows.map(r => {
                const seqInput = r.querySelector(".seq-input");
                const orderId = seqInput.getAttribute("data-orderid");
                const seq = parseInt(seqInput.value || "0", 10) || 0;
                return { orderId, seq };
            }).sort((a, b) => a.seq - b.seq);

            container.innerHTML = "";

            for (let i = 0; i < items.length; i++) {
                const it = items[i];

                const hidId = document.createElement("input");
                hidId.type = "hidden";
                hidId.name = `Orders[${i}].OrderId`;
                hidId.value = it.orderId;

                const hidSeq = document.createElement("input");
                hidSeq.type = "hidden";
                hidSeq.name = `Orders[${i}].Sequence`;
                hidSeq.value = it.seq.toString();

                container.appendChild(hidId);
                container.appendChild(hidSeq);
            }
        }

        function normalizeSequence() {
            const rows = Array.from(document.querySelectorAll("#routeTable tbody tr"));
            // sort theo seq hi·ªán t·∫°i r·ªìi g√°n l·∫°i 1..n
            const sorted = rows.slice().sort((a, b) => {
                const sa = parseInt(a.querySelector(".seq-input").value || "0", 10) || 0;
                const sb = parseInt(b.querySelector(".seq-input").value || "0", 10) || 0;
                return sa - sb;
            });

            for (let i = 0; i < sorted.length; i++) {
                sorted[i].querySelector(".seq-input").value = (i + 1).toString();
            }

            showMapsHint();
        }

        function showMapsHint() {
            const hint = document.getElementById("mapsHint");
            if (hint) hint.classList.remove("d-none");
        }

        function rebuildMapsLinkHint() {
            showMapsHint();
        }

        function moveRowUp(btn) {
            const row = btn.closest("tr");
            const prev = row.previousElementSibling;
            if (!prev) return;

            row.parentNode.insertBefore(row, prev);
            // sau khi ƒë·ªïi v·ªã tr√≠, g√°n l·∫°i seq theo v·ªã tr√≠
            normalizeSequence();
        }

        function moveRowDown(btn) {
            const row = btn.closest("tr");
            const next = row.nextElementSibling;
            if (!next) return;

            row.parentNode.insertBefore(next, row);
            normalizeSequence();
        }

        document.addEventListener("DOMContentLoaded", function () {
            // khi user s·ª≠a seq => nh·∫Øc maps
            document.querySelectorAll(".seq-input").forEach(inp => {
                inp.addEventListener("input", function () {
                    showMapsHint();
                });
            });

            // tr∆∞·ªõc khi submit confirm => build hidden Orders theo seq
            const confirmForm = document.getElementById("confirmForm");
            if (confirmForm) {
                confirmForm.addEventListener("submit", function (e) {
                    rebuildHiddenOrders();

                    // validate ƒë∆°n gi·∫£n: seq ph·∫£i >=1 v√† kh√¥ng tr√πng
                    const seqs = Array.from(document.querySelectorAll(".seq-input"))
                        .map(x => parseInt(x.value || "0", 10) || 0);

                    if (seqs.some(x => x < 1)) {
                        e.preventDefault();
                        alert("Sequence ph·∫£i >= 1. B·∫°n b·∫•m 'Chu·∫©n ho√° Seq (1..n)' ƒë·ªÉ t·ª± s·ª≠a nhanh.");
                        return;
                    }

                    const set = new Set(seqs);
                    if (set.size !== seqs.length) {
                        e.preventDefault();
                        alert("Sequence ƒëang b·ªã tr√πng. B·∫°n b·∫•m 'Chu·∫©n ho√° Seq (1..n)' ƒë·ªÉ t·ª± s·ª≠a nhanh.");
                        return;
                    }
                });
            }

            // build hidden l·∫ßn ƒë·∫ßu (cho ch·∫Øc)
            rebuildHiddenOrders();
        });
    </script>
}
