@using WedNightFury.Controllers
@model WedNightFury.Controllers.AdminRoutePreviewViewModel

@{
    ViewData["Title"] = "Xem tuy·∫øn t·ªëi ∆∞u & ph√¢n c√¥ng";
    Layout = "_LayoutAdmin";

    var orders = (Model.Orders ?? new List<AdminRouteOrderItemViewModel>())
        .OrderBy(o => o.Sequence)
        .ToList();

    var hasHub = Model.HubId.HasValue && Model.HubId.Value > 0;
    var hubText = hasHub
        ? (string.IsNullOrWhiteSpace(Model.HubAddress) ? (Model.HubName ?? "Hub") : $"{Model.HubName} - {Model.HubAddress}")
        : "";

    var hasManualOrigin = !string.IsNullOrWhiteSpace(Model.DriverOriginAddress);
    var originQuery = (Model.DriverOriginQuery ?? "").Trim();
    var hasOriginQuery = !string.IsNullOrWhiteSpace(originQuery);

    bool MissingCoord(AdminRouteOrderItemViewModel o) => !o.Lat.HasValue || !o.Lng.HasValue;
    var missingCount = orders.Count(MissingCoord);
}

<style>
    /* ===== Match your Dashboard style (dash) ===== */
    .dash {
        --text: #111827;
        --muted: #6b7280;
        --border: rgba(17, 24, 39, 0.10);
        --shadow: 0 10px 30px rgba(17, 24, 39, 0.08);
        --shadow2: 0 14px 40px rgba(17, 24, 39, 0.10);
        font-family: "Segoe UI", system-ui, -apple-system, Arial, sans-serif;
        color: var(--text);
    }

    /* ===== Header like dashboard ===== */
    .dash-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 14px;
        padding: 14px 16px;
        border-radius: 16px;
        border: 1px solid var(--border);
        background: linear-gradient(180deg, rgba(13,110,253,.08), rgba(13,110,253,.02));
        box-shadow: var(--shadow);
        margin-bottom: 14px;
        flex-wrap: wrap;
    }
    .dash-left { display: flex; gap: 12px; align-items: center; }
    .dash-avatar {
        width: 44px; height: 44px; border-radius: 14px;
        display: grid; place-items: center;
        background: #fff; border: 1px solid var(--border);
        box-shadow: 0 8px 24px rgba(17,24,39,.08);
        font-size: 20px;
        flex: 0 0 auto;
    }
    .dash-title { font-weight: 950; letter-spacing: -0.2px; margin: 0; }
    .dash-sub {
        color: var(--muted);
        font-size: .95rem;
        margin-top: 4px;
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }
    .dash-dot { width: 6px; height: 6px; border-radius: 99px; background: rgba(17,24,39,0.25); display: inline-block; }

    .dash-pill {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: #fff;
        box-shadow: 0 8px 18px rgba(17,24,39,.06);
        color: var(--muted);
        font-weight: 950;
        font-size: .9rem;
        user-select: none;
        text-decoration: none;
        white-space: nowrap;
    }
    .pill-dot {
        width: 10px; height: 10px; border-radius: 99px;
        background: #22c55e;
        box-shadow: 0 0 0 4px rgba(34,197,94,0.18);
    }

    /* ===== Toast-like alerts ===== */
    .notice{
        border-radius: 16px;
        border: 1px solid var(--border);
        box-shadow: 0 8px 18px rgba(17,24,39,.06);
        padding: 10px 12px;
        display:flex;
        gap:10px;
        align-items:flex-start;
        margin-bottom: 10px;
        background:#fff;
    }
    .notice .ic{
        width:34px;height:34px;border-radius:14px;
        display:grid;place-items:center;
        border: 1px solid var(--border);
        background:#fff;
        flex:0 0 auto;
    }
    .notice .title{font-weight:950;margin:0;}
    .notice .msg{margin:2px 0 0;color:var(--muted);}
    .notice-danger{background: linear-gradient(180deg, rgba(220,53,69,.08), rgba(255,255,255,1)); border-color: rgba(220,53,69,.22);}
    .notice-success{background: linear-gradient(180deg, rgba(25,135,84,.08), rgba(255,255,255,1)); border-color: rgba(25,135,84,.22);}
    .notice-warning{background: linear-gradient(180deg, rgba(255,193,7,.12), rgba(255,255,255,1)); border-color: rgba(255,193,7,.28);}

    /* ===== Panel ===== */
    .panel{
        border-radius:18px;
        border:1px solid var(--border);
        background:#fff;
        box-shadow: var(--shadow);
        overflow:hidden;
        transition: transform .18s ease, box-shadow .18s ease;
    }
    .panel:hover{transform:translateY(-2px);box-shadow:var(--shadow2);}
    .panel-head{
        padding:14px 16px;
        border-bottom: 1px solid rgba(17, 24, 39, 0.08);
        background: linear-gradient(180deg, rgba(17, 24, 39, 0.03), rgba(17, 24, 39, 0.01));
        display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
    }
    .panel-title{font-weight:950;letter-spacing:-.2px;}
    .panel-sub{color:var(--muted);font-size:.92rem;margin-top:4px;}
    .panel-body{padding:14px 16px 16px 16px;}

    /* ===== Pills / badges ===== */
    .tag{
        display:inline-flex;
        align-items:center;
        gap:8px;
        padding:8px 10px;
        border-radius:999px;
        border: 1px solid var(--border);
        background:#fff;
        box-shadow:0 8px 18px rgba(17,24,39,.06);
        color: var(--muted);
        font-weight: 900;
        font-size: .9rem;
        white-space: nowrap;
    }
    .tag-dot{
        width:10px;height:10px;border-radius:99px;background:#0d6efd;
        box-shadow:0 0 0 4px rgba(13,110,253,0.18);
    }
    .tag-warn .tag-dot{ background:#f59e0b; box-shadow:0 0 0 4px rgba(245,158,11,0.18); }
    .tag-ok .tag-dot{ background:#22c55e; box-shadow:0 0 0 4px rgba(34,197,94,0.18); }

    /* ===== Table ===== */
    .table-clean{margin:0;}
    .table-clean thead th{
        background: rgba(17,24,39,0.03) !important;
        font-weight:950;
        color: var(--text);
        border-bottom: 1px solid rgba(17,24,39,0.10) !important;
        white-space: nowrap;
    }
    .table-clean td, .table-clean th{
        padding:.85rem .95rem;
        vertical-align:middle;
        border-color: rgba(17,24,39,0.06);
    }
    .table-clean tbody tr{transition: background .12s ease;}
    .table-clean tbody tr:hover{background: rgba(13,110,253,.04);}

    .seq-input{
        border-radius: 12px;
        border-color: rgba(17,24,39,0.12);
        padding: .4rem .6rem;
        font-weight: 900;
    }
    .seq-input:focus{
        box-shadow: 0 0 0 .2rem rgba(13,110,253,.12);
        border-color: rgba(13,110,253,.35);
    }

    .addr{
        max-width: 420px;
        overflow:hidden;
        text-overflow:ellipsis;
        white-space:nowrap;
    }

    .btn-pill{
        border-radius:999px !important;
        font-weight:950;
        padding:.55rem .95rem;
        white-space:nowrap;
    }
    .btn-ghost{
        border-radius:999px !important;
        font-weight:950;
        padding:.55rem .95rem;
        background:#fff;
        border: 1px solid rgba(17,24,39,0.14);
    }

    .soft-box{
        border:1px solid rgba(17,24,39,0.10);
        background: rgba(17,24,39,0.02);
        border-radius: 16px;
        padding: 12px;
    }
    .hint{
        font-size: .92rem;
        color: var(--muted);
        line-height: 1.55;
        border-left: 3px solid rgba(13, 110, 253, 0.35);
        padding-left: 10px;
    }

    /* ===== Right panel content ===== */
    #mapsUrlBox{
        border-radius: 14px;
        border-color: rgba(17,24,39,0.12);
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: .9rem;
    }

    @@media (max-width: 992px){
        .addr{max-width: 100%;}
    }
</style>

<div class="dash container-fluid py-3">

    <!-- Header -->
    <div class="dash-head">
        <div class="dash-left">
            <div class="dash-avatar">üß≠</div>
            <div>
                <h2 class="dash-title">Xem tuy·∫øn t·ªëi ∆∞u & ph√¢n c√¥ng</h2>
                <div class="dash-sub">
                    <span><b>@Model.DriverName</b> ‚Äì @Model.DeliveryDate.ToString("dd/MM/yyyy")</span>
                    <span class="dash-dot"></span>
                    <span class="text-muted">T·ªïng ƒëi·ªÉm giao: <b>@orders.Count</b></span>
                    @if (missingCount > 0)
                    {
                        <span class="dash-dot"></span>
                        <span class="text-muted">Thi·∫øu t·ªça ƒë·ªô: <b>@missingCount</b></span>
                    }
                </div>
            </div>
        </div>

        <a asp-action="NewOrders" class="dash-pill">
            <span class="pill-dot"></span>
            <span><i class="fas fa-arrow-left me-1"></i> Quay l·∫°i danh s√°ch ƒë∆°n</span>
        </a>
    </div>

    <!-- Notices -->
    @if (TempData["Error"] != null)
    {
        <div class="notice notice-danger">
            <div class="ic">‚õî</div>
            <div>
                <p class="title mb-0">C√≥ l·ªói</p>
                <p class="msg mb-0">@TempData["Error"]</p>
            </div>
        </div>
    }
    @if (TempData["Success"] != null)
    {
        <div class="notice notice-success">
            <div class="ic">‚úÖ</div>
            <div>
                <p class="title mb-0">Th√†nh c√¥ng</p>
                <p class="msg mb-0">@TempData["Success"]</p>
            </div>
        </div>
    }
    @if (TempData["Warning"] != null)
    {
        <div class="notice notice-warning">
            <div class="ic">‚ö†Ô∏è</div>
            <div>
                <p class="title mb-0">L∆∞u √Ω</p>
                <p class="msg mb-0">@TempData["Warning"]</p>
            </div>
        </div>
    }

    @if (!orders.Any())
    {
        <div class="panel">
            <div class="panel-body">
                <div class="soft-box">
                    <div class="fw-bold">Kh√¥ng c√≥ ƒë∆°n n√†o trong tuy·∫øn ƒë·ªÉ ph√¢n c√¥ng.</div>
                    <div class="text-muted small mt-1">B·∫°n h√£y quay l·∫°i danh s√°ch v√† ch·ªçn ƒë∆°n tr∆∞·ªõc khi t·ªëi ∆∞u tuy·∫øn.</div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="row g-3">
            <!-- LEFT -->
            <div class="col-lg-6">

                <div class="panel mb-3">
                    <div class="panel-head">
                        <div>
                            <div class="panel-title"><i class="fas fa-list-check me-1"></i> Danh s√°ch ƒëi·ªÉm giao</div>
                            <div class="panel-sub">C√≥ th·ªÉ ch·ªânh th·ª© t·ª± (Seq) tr∆∞·ªõc khi x√°c nh·∫≠n l∆∞u tuy·∫øn.</div>
                        </div>

                        <div class="d-flex gap-2 flex-wrap">
                            @if (missingCount > 0)
                            {
                                <span class="tag tag-warn">
                                    <span class="tag-dot"></span>
                                    @missingCount ƒë∆°n thi·∫øu Lat/Lng
                                </span>
                            }
                            else
                            {
                                <span class="tag tag-ok">
                                    <span class="tag-dot"></span>
                                    T·ªça ƒë·ªô ƒë·∫ßy ƒë·ªß
                                </span>
                            }
                        </div>
                    </div>

                    <div class="panel-body">
                        <div class="soft-box mb-3">
                            <div class="small text-muted">ƒêi·ªÉm xu·∫•t ph√°t</div>

                            <div class="fw-semibold mt-1">
                                @if (hasHub)
                                {
                                    <span class="badge bg-primary me-2">Hub</span>
                                    @hubText
                                }
                                else if (hasManualOrigin)
                                {
                                    <span class="badge bg-secondary me-2">Nh·∫≠p tay</span>
                                    @Model.DriverOriginAddress
                                }
                                else
                                {
                                    <span class="text-muted">
                                        (Kh√¥ng ch·ªçn Hub / kh√¥ng nh·∫≠p ‚Äì Google Maps c√≥ th·ªÉ d√πng ƒëi·ªÉm giao ƒë·∫ßu ti√™n l√†m ƒëi·ªÉm xu·∫•t ph√°t)
                                    </span>
                                }
                            </div>

                            @if (hasOriginQuery)
                            {
                                <div class="small text-muted mt-2">
                                    Query t·∫°o Google Maps: <code>@originQuery</code>
                                </div>
                            }
                        </div>

                        <div class="hint">
                            Tip: Tuy·∫øn ‚Äúl·∫°‚Äù th∆∞·ªùng do thi·∫øu Lat/Lng ho·∫∑c Lat/Lng sai. B·∫°n c√≥ th·ªÉ ch·ªânh Seq th·ªß c√¥ng r·ªìi b·∫•m X√°c nh·∫≠n.
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-clean table-hover mb-0 align-middle" id="routeTable">
                            <thead>
                                <tr>
                                    <th style="width: 90px;">Seq</th>
                                    <th style="width: 160px;">M√£ ƒë∆°n</th>
                                    <th>ƒê·ªãa ch·ªâ nh·∫≠n</th>
                                    <th style="width: 170px;">Lat/Lng</th>
                                    <th style="width: 90px;">‚Üë‚Üì</th>
                                </tr>
                            </thead>
                            <tbody>
                                @for (int i = 0; i < orders.Count; i++)
                                {
                                    var o = orders[i];
                                    var missing = MissingCoord(o);

                                    <tr data-row="@i">
                                        <td>
                                            <input type="number"
                                                   class="form-control form-control-sm seq-input"
                                                   min="1"
                                                   value="@o.Sequence"
                                                   data-orderid="@o.OrderId" />
                                        </td>

                                        <td class="fw-bold">@o.Code</td>

                                        <td class="addr">
                                            @o.ReceiverAddress
                                            @if (missing)
                                            {
                                                <span class="badge bg-warning text-dark ms-2">Thi·∫øu Lat/Lng</span>
                                            }
                                        </td>

                                        <td class="small text-muted text-nowrap">
                                            @if (!missing)
                                            {
                                                <span>@o.Lat.Value.ToString("0.######"), @o.Lng.Value.ToString("0.######")</span>
                                            }
                                            else
                                            {
                                                <span>-</span>
                                            }
                                        </td>

                                        <td>
                                            <div class="d-flex gap-1">
                                                <button type="button" class="btn btn-sm btn-outline-secondary btn-pill py-1 px-2" onclick="moveRowUp(this)">‚Üë</button>
                                                <button type="button" class="btn btn-sm btn-outline-secondary btn-pill py-1 px-2" onclick="moveRowDown(this)">‚Üì</button>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <div class="panel-body">
                        <div class="d-flex gap-2 flex-wrap">
                            <button type="button" class="btn btn-outline-secondary btn-pill btn-sm" onclick="normalizeSequence()">
                                <i class="fas fa-arrows-rotate me-1"></i> Chu·∫©n ho√° Seq (1..n)
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-pill btn-sm" onclick="rebuildMapsLinkHint()">
                                <i class="fas fa-circle-info me-1"></i> Nh·∫Øc c·∫≠p nh·∫≠t Google Maps
                            </button>
                        </div>

                        <small class="text-muted d-block mt-2">
                            Khi b·∫°n ch·ªânh th·ª© t·ª±, link Google Maps ƒëang hi·ªÉn th·ªã c√≥ th·ªÉ ch∆∞a kh·ªõp 100%.
                            B·∫°n n√™n b·∫•m ‚ÄúM·ªü tuy·∫øn‚Äù l·∫°i sau khi X√°c nh·∫≠n, ho·∫∑c quay l·∫°i Preview l·∫ßn n·ªØa.
                        </small>
                    </div>
                </div>

                <!-- CONFIRM FORM -->
                <form asp-action="ConfirmAssignRoute"
                      asp-controller="AdminOrders"
                      method="post"
                      id="confirmForm"
                      class="panel">
                    @Html.AntiForgeryToken()

                    <div class="panel-head">
                        <div>
                            <div class="panel-title"><i class="fas fa-check me-1"></i> X√°c nh·∫≠n ph√¢n c√¥ng</div>
                            <div class="panel-sub">L∆∞u DriverId + DeliveryDate + Sequence cho t·ª´ng ƒë∆°n theo b·∫£ng hi·ªán t·∫°i.</div>
                        </div>

                        <span class="tag">
                            <span class="tag-dot"></span>
                            @Model.DriverName
                        </span>
                    </div>

                    <div class="panel-body">
                        <input type="hidden" name="DriverId" value="@Model.DriverId" />
                        <input type="hidden" name="DeliveryDate" value="@Model.DeliveryDate.ToString("yyyy-MM-dd")" />

                        <input type="hidden" name="HubId" value="@(Model.HubId ?? 0)" />
                        <input type="hidden" name="DriverOriginAddress" value="@(Model.DriverOriginAddress ?? "")" />
                        <input type="hidden" name="DriverOriginQuery" value="@(Model.DriverOriginQuery ?? "")" />

                        <!-- ‚úÖ container hidden Orders[i] s·∫Ω ƒë∆∞·ª£c build t·ª´ JS theo b·∫£ng hi·ªán t·∫°i -->
                        <div id="ordersHiddenContainer"></div>

                        <div class="d-flex justify-content-between gap-2 flex-wrap mt-2">
                            <a asp-action="NewOrders" class="btn btn-ghost btn-pill">
                                <i class="fas fa-arrow-left me-1"></i> Quay l·∫°i
                            </a>
                            <button type="submit" class="btn btn-success btn-pill">
                                <i class="fas fa-save me-1"></i> X√°c nh·∫≠n & l∆∞u tuy·∫øn
                            </button>
                        </div>

                        <small class="text-muted d-block mt-3">
                            Khi x√°c nh·∫≠n, h·ªá th·ªëng s·∫Ω l∆∞u <strong>DriverId</strong> + <strong>DeliveryDate</strong> + <strong>Sequence</strong> cho t·ª´ng ƒë∆°n.
                        </small>
                    </div>
                </form>
            </div>

            <!-- RIGHT -->
            <div class="col-lg-6">
                <div class="panel">
                    <div class="panel-head">
                        <div>
                            <div class="panel-title"><i class="fas fa-map-location-dot me-1"></i> Tuy·∫øn ƒë∆∞·ªùng tr√™n Google Maps</div>
                            <div class="panel-sub">Hi·ªÉn th·ªã tuy·∫øn theo Sequence hi·ªán t·∫°i (t·ª´ server).</div>
                        </div>

                        @if (!string.IsNullOrWhiteSpace(Model.GoogleMapsUrl))
                        {
                            <span class="tag tag-ok">
                                <span class="tag-dot"></span>
                                C√≥ link Maps
                            </span>
                        }
                        else
                        {
                            <span class="tag tag-warn">
                                <span class="tag-dot"></span>
                                Ch∆∞a t·∫°o ƒë∆∞·ª£c
                            </span>
                        }
                    </div>

                    <div class="panel-body">
                        @if (string.IsNullOrWhiteSpace(Model.GoogleMapsUrl))
                        {
                            <div class="soft-box">
                                <div class="fw-bold">Ch∆∞a t·∫°o ƒë∆∞·ª£c tuy·∫øn tr√™n Google Maps</div>
                                <div class="text-muted small mt-1">
                                    Nguy√™n nh√¢n th∆∞·ªùng g·∫∑p: thi·∫øu ƒë·ªãa ch·ªâ/t·ªça ƒë·ªô h·ª£p l·ªá.
                                    Vui l√≤ng ki·ªÉm tra l·∫°i <strong>ƒë·ªãa ch·ªâ ng∆∞·ªùi nh·∫≠n</strong> ho·∫∑c <strong>Lat/Lng</strong>.
                                </div>
                            </div>
                        }
                        else
                        {
                            <p class="mb-2">
                                Tuy·∫øn ƒë∆∞·ª£c t·∫°o theo <strong>Sequence</strong> ·ªü b·∫£ng b√™n tr√°i (t·ª´ server).
                                N·∫øu b·∫°n v·ª´a ch·ªânh Seq th·ªß c√¥ng, h√£y <strong>X√°c nh·∫≠n</strong> tr∆∞·ªõc r·ªìi m·ªü l·∫°i tuy·∫øn.
                            </p>

                            <div class="d-flex gap-2 flex-wrap">
                                <a class="btn btn-primary btn-pill"
                                   href="@Model.GoogleMapsUrl"
                                   target="_blank"
                                   rel="noopener">
                                    üó∫ M·ªü tuy·∫øn tr√™n Google Maps
                                </a>

                                <button type="button" class="btn btn-outline-secondary btn-pill" onclick="copyMapsUrl()">
                                    üìã Copy link
                                </button>
                            </div>

                            <small class="text-muted d-block mt-2">
                                Tr√™n Google Maps:
                                ƒëi·ªÉm <strong>A</strong> = ƒëi·ªÉm xu·∫•t ph√°t (Hub ho·∫∑c nh·∫≠p tay n·∫øu c√≥),
                                ƒëi·ªÉm <strong>B</strong> = ƒëi·ªÉm cu·ªëi,
                                c√°c ƒëi·ªÉm ·ªü gi·ªØa = c√°c ƒëi·ªÉm giao c√≤n l·∫°i.
                            </small>

                            <textarea id="mapsUrlBox" class="form-control mt-2" rows="4" readonly>@Model.GoogleMapsUrl</textarea>

                            <div class="notice notice-warning mt-3 mb-0 d-none" id="mapsHint">
                                <div class="ic">‚ö†Ô∏è</div>
                                <div>
                                    <p class="title mb-0">Th·ª© t·ª± Seq v·ª´a thay ƒë·ªïi</p>
                                    <p class="msg mb-0">
                                        Link Google Maps hi·ªán t·∫°i c√≥ th·ªÉ ch∆∞a kh·ªõp. H√£y b·∫•m <strong>X√°c nh·∫≠n</strong> ƒë·ªÉ l∆∞u Seq m·ªõi, r·ªìi m·ªü l·∫°i tuy·∫øn.
                                    </p>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <script>
            function copyMapsUrl() {
                const box = document.getElementById('mapsUrlBox');
                if (!box) return;

                const text = box.value || box.textContent || "";
                if (!text) return;

                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(text)
                        .then(() => alert("ƒê√£ copy link Google Maps!"))
                        .catch(() => fallbackCopy(text));
                } else {
                    fallbackCopy(text);
                }
            }

            function fallbackCopy(text) {
                const temp = document.createElement("textarea");
                temp.value = text;
                document.body.appendChild(temp);
                temp.select();
                try { document.execCommand("copy"); } catch (e) { }
                document.body.removeChild(temp);
                alert("ƒê√£ copy link Google Maps!");
            }

            function rebuildHiddenOrders() {
                const container = document.getElementById("ordersHiddenContainer");
                const rows = Array.from(document.querySelectorAll("#routeTable tbody tr"));

                const items = rows.map(r => {
                    const seqInput = r.querySelector(".seq-input");
                    const orderId = seqInput.getAttribute("data-orderid");
                    const seq = parseInt(seqInput.value || "0", 10) || 0;
                    return { orderId, seq };
                }).sort((a, b) => a.seq - b.seq);

                container.innerHTML = "";

                for (let i = 0; i < items.length; i++) {
                    const it = items[i];

                    const hidId = document.createElement("input");
                    hidId.type = "hidden";
                    hidId.name = `Orders[${i}].OrderId`;
                    hidId.value = it.orderId;

                    const hidSeq = document.createElement("input");
                    hidSeq.type = "hidden";
                    hidSeq.name = `Orders[${i}].Sequence`;
                    hidSeq.value = it.seq.toString();

                    container.appendChild(hidId);
                    container.appendChild(hidSeq);
                }
            }

            function normalizeSequence() {
                const rows = Array.from(document.querySelectorAll("#routeTable tbody tr"));

                const sorted = rows.slice().sort((a, b) => {
                    const sa = parseInt(a.querySelector(".seq-input").value || "0", 10) || 0;
                    const sb = parseInt(b.querySelector(".seq-input").value || "0", 10) || 0;
                    return sa - sb;
                });

                for (let i = 0; i < sorted.length; i++) {
                    sorted[i].querySelector(".seq-input").value = (i + 1).toString();
                }

                showMapsHint();
            }

            function showMapsHint() {
                const hint = document.getElementById("mapsHint");
                if (hint) hint.classList.remove("d-none");
            }

            function rebuildMapsLinkHint() {
                showMapsHint();
            }

            function moveRowUp(btn) {
                const row = btn.closest("tr");
                const prev = row.previousElementSibling;
                if (!prev) return;

                row.parentNode.insertBefore(row, prev);
                normalizeSequence();
            }

            function moveRowDown(btn) {
                const row = btn.closest("tr");
                const next = row.nextElementSibling;
                if (!next) return;

                row.parentNode.insertBefore(next, row);
                normalizeSequence();
            }

            document.addEventListener("DOMContentLoaded", function () {
                document.querySelectorAll(".seq-input").forEach(inp => {
                    inp.addEventListener("input", function () {
                        showMapsHint();
                    });
                });

                const confirmForm = document.getElementById("confirmForm");
                if (confirmForm) {
                    confirmForm.addEventListener("submit", function (e) {
                        rebuildHiddenOrders();

                        const seqs = Array.from(document.querySelectorAll(".seq-input"))
                            .map(x => parseInt(x.value || "0", 10) || 0);

                        if (seqs.some(x => x < 1)) {
                            e.preventDefault();
                            alert("Sequence ph·∫£i >= 1. B·∫°n b·∫•m 'Chu·∫©n ho√° Seq (1..n)' ƒë·ªÉ t·ª± s·ª≠a nhanh.");
                            return;
                        }

                        const set = new Set(seqs);
                        if (set.size !== seqs.length) {
                            e.preventDefault();
                            alert("Sequence ƒëang b·ªã tr√πng. B·∫°n b·∫•m 'Chu·∫©n ho√° Seq (1..n)' ƒë·ªÉ t·ª± s·ª≠a nhanh.");
                            return;
                        }
                    });
                }

                rebuildHiddenOrders();
            });
        </script>
    }
</div>
