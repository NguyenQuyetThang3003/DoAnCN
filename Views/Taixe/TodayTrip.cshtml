@model List<WedNightFury.Models.Order>
@{
    ViewData["Title"] = "L·ªô tr√¨nh h√¥m nay";
}

<div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="fw-bold m-0">üó∫ L·ªò TR√åNH GIAO H√ÄNG H√îM NAY</h2>

    @if (Model != null && Model.Any())
    {
        <div class="d-flex align-items-center" style="gap:10px;">
            <button type="button" id="btnSelectAll" class="btn btn-outline-secondary btn-sm">
                Ch·ªçn t·∫•t c·∫£
            </button>

            <button type="button" id="btnStartBatch" class="btn btn-primary btn-sm">
                üöÄ B·∫Øt ƒë·∫ßu giao c√°c ƒë∆°n ƒë√£ ch·ªçn
            </button>

            <button type="button" id="btnMapsBatch" class="btn btn-outline-success btn-sm">
                üß≠ M·ªü Google Maps t·ªëi ∆∞u l·ªô tr√¨nh
            </button>
        </div>
    }
</div>

<div id="batchMsg" class="alert d-none" role="alert"></div>

@if (Model == null || !Model.Any())
{
    <div class="alert alert-warning">H√¥m nay b·∫°n ch∆∞a c√≥ chuy·∫øn n√†o.</div>
}
else
{
    <ol class="list-group list-group-numbered" id="orderList">
        @foreach (var order in Model)
        {
            <li class="list-group-item d-flex justify-content-between align-items-start">
                <div class="d-flex align-items-start" style="gap:12px;">
                    <!-- ‚úÖ checkbox -->
                    <div class="pt-1">
                        <input class="form-check-input order-check"
                               type="checkbox"
                               value="@order.Id"
                               data-code="@order.Code"
                               aria-label="Ch·ªçn ƒë∆°n @order.Code" />
                    </div>

                    <div class="ms-1 me-auto">
                        <div class="fw-bold">
                            @order.ReceiverName (@order.Code)
                            @if (!string.IsNullOrWhiteSpace(order.Status))
                            {
                                <span class="badge bg-secondary ms-2">@order.Status</span>
                            }
                        </div>

                        <div>
                            <i class="fa fa-location-dot"></i>
                            @order.ReceiverAddress
                        </div>

                        <div>
                            <i class="fa fa-phone"></i>
                            @order.ReceiverPhone
                        </div>

                        @if (order.CodAmount > 0)
                        {
                            <div class="mt-1">
                                <span class="badge bg-warning text-dark">
                                    COD: @order.CodAmount.ToString("N0") ƒë
                                </span>
                            </div>
                        }
                    </div>
                </div>

                <!-- n√∫t ƒë∆°n l·∫ª v·∫´n gi·ªØ -->
                <div class="d-flex flex-column" style="gap:6px;">
                    @if (order.Lat != null && order.Lng != null)
                    {
                        <a class="btn btn-outline-primary btn-sm"
                           href="https://www.google.com/maps/dir/?api=1&destination=@order.Lat,@order.Lng"
                           target="_blank">
                            ƒêi·ªÅu h∆∞·ªõng
                        </a>
                    }
                    else
                    {
                        <a class="btn btn-outline-primary btn-sm"
                           href="https://www.google.com/maps/search/?api=1&query=@Uri.EscapeDataString(order.ReceiverAddress ?? "")"
                           target="_blank">
                            ƒêi·ªÅu h∆∞·ªõng
                        </a>
                    }

                    <a asp-action="StopDetail" asp-route-id="@order.Id" class="btn btn-dark btn-sm">
                        Chi ti·∫øt
                    </a>
                </div>
            </li>
        }
    </ol>
}

<script>
    function showMsg(type, text) {
        const box = document.getElementById("batchMsg");
        box.classList.remove("d-none", "alert-success", "alert-danger", "alert-warning", "alert-info");
        box.classList.add("alert-" + type);
        box.textContent = text;
        window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function getSelectedIds() {
        return Array.from(document.querySelectorAll(".order-check:checked"))
            .map(cb => parseInt(cb.value, 10))
            .filter(x => !isNaN(x));
    }

    function setAllChecks(checked) {
        document.querySelectorAll(".order-check").forEach(cb => cb.checked = checked);
    }

    function updateSelectAllButton() {
        const all = Array.from(document.querySelectorAll(".order-check"));
        const checked = all.filter(x => x.checked);
        const btn = document.getElementById("btnSelectAll");
        if (!btn) return;
        btn.textContent = (all.length > 0 && checked.length === all.length) ? "B·ªè ch·ªçn" : "Ch·ªçn t·∫•t c·∫£";
    }

    document.addEventListener("DOMContentLoaded", () => {
        const btnSelectAll = document.getElementById("btnSelectAll");
        const btnStartBatch = document.getElementById("btnStartBatch");
        const btnMapsBatch = document.getElementById("btnMapsBatch");

        // checkbox change -> ƒë·ªïi text n√∫t ch·ªçn t·∫•t c·∫£
        document.querySelectorAll(".order-check").forEach(cb => {
            cb.addEventListener("change", updateSelectAllButton);
        });
        updateSelectAllButton();

        // ‚úÖ ch·ªçn t·∫•t c·∫£ / b·ªè ch·ªçn
        btnSelectAll?.addEventListener("click", () => {
            const all = Array.from(document.querySelectorAll(".order-check"));
            const checked = all.filter(x => x.checked);
            const isAllChecked = (all.length > 0 && checked.length === all.length);
            setAllChecks(!isAllChecked);
            updateSelectAllButton();
        });

        // ‚úÖ b·∫Øt ƒë·∫ßu giao h√†ng lo·∫°t
        btnStartBatch?.addEventListener("click", async () => {
            const ids = getSelectedIds();
            if (ids.length === 0) {
                showMsg("warning", "Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 ƒë∆°n.");
                return;
            }

            try {
                btnStartBatch.disabled = true;
                btnStartBatch.textContent = "ƒêang c·∫≠p nh·∫≠t...";

                const res = await fetch("/Taixe/UpdateStatusBatch", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ orderIds: ids, status: "shipping" })
                });

                const data = await res.json().catch(() => ({}));

                if (!res.ok) {
                    showMsg("danger", data.message || "C·∫≠p nh·∫≠t th·∫•t b·∫°i.");
                    return;
                }

                showMsg("success", `ƒê√£ c·∫≠p nh·∫≠t ${data.updated}/${data.total} ƒë∆°n sang tr·∫°ng th√°i SHIPPING.`);
                // reload ƒë·ªÉ UI ph·∫£n √°nh tr·∫°ng th√°i m·ªõi
                setTimeout(() => location.reload(), 600);

            } catch (e) {
                showMsg("danger", "C√≥ l·ªói khi c·∫≠p nh·∫≠t lo·∫°t: " + (e?.message || e));
            } finally {
                btnStartBatch.disabled = false;
                btnStartBatch.textContent = "üöÄ B·∫Øt ƒë·∫ßu giao c√°c ƒë∆°n ƒë√£ ch·ªçn";
            }
        });

        // ‚úÖ m·ªü google maps theo nh√≥m
        btnMapsBatch?.addEventListener("click", async () => {
            const ids = getSelectedIds();
            if (ids.length === 0) {
                showMsg("warning", "Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 ƒë∆°n ƒë·ªÉ m·ªü Maps.");
                return;
            }

            try {
                btnMapsBatch.disabled = true;
                btnMapsBatch.textContent = "ƒêang t·∫°o link Maps...";

                const res = await fetch("/Taixe/OpenMapsBatch", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ orderIds: ids, maxStopsPerUrl: 9 })
                });

                const data = await res.json().catch(() => ({}));

                if (!res.ok) {
                    showMsg("danger", data.message || "Kh√¥ng t·∫°o ƒë∆∞·ª£c link Maps.");
                    return;
                }

                const urls = data.mapUrls || [];
                if (urls.length === 0) {
                    showMsg("warning", "Kh√¥ng c√≥ ƒë·ªß d·ªØ li·ªáu ƒë·ªãa ch·ªâ/to·∫° ƒë·ªô ƒë·ªÉ m·ªü Maps.");
                    return;
                }

                showMsg("info", `ƒêang m·ªü ${urls.length} tab Google Maps (ƒë√£ t·ª± chia nh√≥m ƒëi·ªÉm d·ª´ng)...`);
                urls.forEach(u => window.open(u, "_blank"));

            } catch (e) {
                showMsg("danger", "C√≥ l·ªói khi m·ªü Maps: " + (e?.message || e));
            } finally {
                btnMapsBatch.disabled = false;
                btnMapsBatch.textContent = "üß≠ M·ªü Google Maps t·ªëi ∆∞u l·ªô tr√¨nh";
            }
        });
    });
</script>
