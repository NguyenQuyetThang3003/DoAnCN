@model IEnumerable<WedNightFury.Models.Order>
@using System.Globalization
@using System.Text.Json
@using System.Text.RegularExpressions

@{
    ViewData["Title"] = "L·ªô tr√¨nh h√¥m nay";
    Layout = "~/Views/Shared/_LayoutDriver.cshtml";

    var orders = (Model ?? Enumerable.Empty<WedNightFury.Models.Order>()).ToList();

    string NormalizeAddressLight(string raw)
    {
        var addr = (raw ?? "").Trim();
        if (string.IsNullOrWhiteSpace(addr)) return "";

        addr = Regex.Replace(addr, @"\s+", " ").Trim();
        var lower = addr.ToLowerInvariant();

        bool hasVN = lower.Contains("vi·ªát nam") || lower.Contains("viet nam");
        if (!hasVN) addr += ", Vi·ªát Nam";

        return addr;
    }

    // ‚úÖ CH·ªà TR·∫¢ V·ªÄ lat,lng n·∫øu c√≥. Kh√¥ng fallback text cho batch route.
    string BuildStopLatLngOnly(WedNightFury.Models.Order o)
    {
        if (o.Lat.HasValue && o.Lng.HasValue)
        {
            var lat = o.Lat.Value.ToString(CultureInfo.InvariantCulture);
            var lng = o.Lng.Value.ToString(CultureInfo.InvariantCulture);
            return $"{lat},{lng}";
        }
        return ""; // thi·∫øu t·ªça ƒë·ªô
    }

    // Map OrderId -> stop lat,lng (ho·∫∑c "")
    var stopMap = orders.ToDictionary(o => o.Id, o => BuildStopLatLngOnly(o));
    var stopMapJson = JsonSerializer.Serialize(stopMap);

    int activeIndex = 1;

    // n·∫øu mu·ªën xu·∫•t ph√°t t·ª´ HUB (lat,lng) truy·ªÅn t·ª´ controller
    var hubOrigin = (ViewBag.HubLatLng as string) ?? "";
}

<style>
    .order-card { border-radius: 12px; border: none; padding: 20px; transition: .2s; cursor: default; background:#fff; }
    .order-card:hover { transform: scale(1.01); box-shadow: 0 4px 16px rgba(0,0,0,.1); }
    .order-card.suggested { border: 2px solid #28a745; }
    .order-number { font-size:22px;font-weight:700;width:45px;height:45px;border-radius:50%;background:#007bff;color:#fff;display:flex;align-items:center;justify-content:center;margin-right:12px;flex:0 0 auto; }
    .order-number.inactive { background:#6c757d; }
    .info-label { font-weight:600; color:#555; }
    .top-actions { border:1px solid #e9ecef;background:#fff;border-radius:12px;padding:12px 14px; }
</style>

<div class="container">
    <h3 class="fw-bold mb-3">
        üìç L·ªô tr√¨nh giao h√†ng h√¥m nay
        <span class="badge bg-success ms-2">S·∫Øp x·∫øp theo th·ª© t·ª± ƒë·ªÅ xu·∫•t</span>
    </h3>

    @if (!orders.Any())
    {
        <div class="alert alert-info shadow-sm">H√¥m nay b·∫°n ch∆∞a c√≥ ƒë∆°n n√†o c·∫ßn giao.</div>
    }
    else
    {
        <form id="antiForgeryForm" method="post" style="display:none;">
            @Html.AntiForgeryToken()
        </form>

        <div class="top-actions d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
            <div class="d-flex align-items-center gap-3">
                <div class="form-check m-0">
                    <input class="form-check-input" type="checkbox" id="chkAll" />
                    <label class="form-check-label" for="chkAll">Ch·ªçn t·∫•t c·∫£</label>
                </div>
                <span class="text-muted">ƒê√£ ch·ªçn: <b id="selectedCount">0</b></span>
            </div>

            <div class="d-flex align-items-center gap-2">
                <button type="button" id="btnMapsBatch" class="btn btn-outline-dark btn-sm">üó∫ M·ªü Google Maps</button>
                <button type="button" id="btnStartMulti" class="btn btn-primary btn-sm">üöÄ B·∫Øt ƒë·∫ßu giao c√°c ƒë∆°n ƒë√£ ch·ªçn</button>

                <div class="form-check ms-2">
                    <input class="form-check-input" type="checkbox" id="chkOptimize" />
                    <label class="form-check-label text-muted" for="chkOptimize">T·ªëi ∆∞u l·ªô tr√¨nh</label>
                </div>
            </div>
        </div>

        @foreach (var o in orders)
        {
            bool isActiveStatus = o.Status == "pending" || o.Status == "assigned" || o.Status == "shipping";
            bool isFirstActive = isActiveStatus && (activeIndex == 1);

            var stopLatLng = BuildStopLatLngOnly(o);
            var addressText = NormalizeAddressLight(o.ReceiverAddress);

            // ‚úÖ N√∫t ‚ÄúB·∫£n ƒë·ªì‚Äù ƒë∆°n l·∫ª:
            // - n·∫øu c√≥ lat,lng -> ƒëi ƒë√∫ng tuy·ªát ƒë·ªëi
            // - n·∫øu thi·∫øu -> search theo address (ch·∫•p nh·∫≠n c√≥ th·ªÉ sai, nh∆∞ng ch·ªâ 1 ƒëi·ªÉm)
            string singleMapUrl;
            if (!string.IsNullOrWhiteSpace(stopLatLng))
                singleMapUrl = "https://www.google.com/maps/dir/?api=1&origin=My+Location&destination=" + Uri.EscapeDataString(stopLatLng);
            else if (!string.IsNullOrWhiteSpace(addressText))
                singleMapUrl = "https://www.google.com/maps/search/?api=1&query=" + Uri.EscapeDataString(addressText);
            else
                singleMapUrl = "https://www.google.com/maps";

            <div class="order-card shadow-sm mb-4 @(isFirstActive ? "suggested" : "")" data-order-id="@o.Id">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <div class="order-number @(isActiveStatus ? "" : "inactive")" style="@(isFirstActive ? "background:#28a745;" : "")">
                            @(isActiveStatus ? activeIndex : "-")
                        </div>

                        <div class="form-check me-2">
                            <input class="form-check-input order-select"
                                   type="checkbox"
                                   value="@o.Id"
                                   @(isActiveStatus ? "" : "disabled") />
                        </div>

                        <h5 class="fw-bold mb-0">
                            ƒê∆°n: @o.Code
                            @if (isFirstActive)
                            {
                                <span class="badge bg-success ms-2">G·ª£i √Ω</span>
                            }
                        </h5>
                    </div>

                    <span class="badge
                        @(o.Status == "pending"  ? "bg-warning text-dark" :
                          o.Status == "assigned" ? "bg-danger" :
                          o.Status == "shipping" ? "bg-primary" :
                          o.Status == "done"     ? "bg-success" :
                          o.Status == "failed"   ? "bg-danger"  :
                          "bg-secondary")">
                        @o.Status?.ToUpper()
                    </span>
                </div>

                <hr />

                <div class="row">
                    <div class="col-md-6 mb-2">
                        <p><span class="info-label">üë§ Ng∆∞·ªùi nh·∫≠n:</span> @o.ReceiverName</p>
                        <p><span class="info-label">üìû SƒêT:</span> @o.ReceiverPhone</p>
                        <p><span class="info-label">üìç ƒê·ªãa ch·ªâ:</span> @o.ReceiverAddress</p>

                        @if (!string.IsNullOrWhiteSpace(stopLatLng))
                        {
                            <p class="text-muted mb-0"><span class="info-label">üß≠ Stop:</span> @stopLatLng</p>
                        }
                        else
                        {
                            <p class="text-danger mb-0"><span class="info-label">üß≠ Stop:</span> Ch∆∞a c√≥ t·ªça ƒë·ªô (Lat/Lng)</p>
                        }
                    </div>
                    <div class="col-md-6 mb-2">
                        <p><span class="info-label">üì¶ S·∫£n ph·∫©m:</span> @o.ProductName</p>
                        <p><span class="info-label">‚öñ C√¢n n·∫∑ng:</span> @o.Weight kg</p>
                        <p><span class="info-label">üí∞ COD:</span> @o.CodAmount.ToString("N0") ƒë</p>
                    </div>
                </div>

                <div class="mt-3 d-flex flex-wrap gap-2">
                    <a asp-controller="Taixe" asp-action="StopDetail" asp-route-id="@o.Id" class="btn btn-sm btn-primary">
                        üöÄ B·∫Øt ƒë·∫ßu giao
                    </a>

                    <a class="btn btn-sm btn-outline-dark" target="_blank" href="@singleMapUrl">
                        üó∫ B·∫£n ƒë·ªì
                    </a>

                    <a asp-controller="Taixe" asp-action="StopDetail" asp-route-id="@o.Id" class="btn btn-sm btn-outline-secondary">
                        üìÑ Chi ti·∫øt
                    </a>
                </div>
            </div>

            if (isActiveStatus) { activeIndex++; }
        }
    }
</div>

@section Scripts {
<script>
    const STOP_MAP = @Html.Raw(stopMapJson);
    const HUB_ORIGIN = "@hubOrigin".trim();

    function getToken() {
        return document.querySelector('#antiForgeryForm input[name="__RequestVerificationToken"]')?.value || "";
    }

    function getCheckboxes() {
        return Array.from(document.querySelectorAll(".order-select")).filter(x => !x.disabled);
    }
    function getSelectedIds() {
        return Array.from(document.querySelectorAll(".order-select:checked"))
            .filter(x => !x.disabled)
            .map(x => parseInt(x.value, 10))
            .filter(x => !isNaN(x));
    }

    function refreshSelectedCount() {
        const ids = getSelectedIds();
        document.getElementById("selectedCount").textContent = ids.length.toString();

        const all = getCheckboxes();
        const selected = Array.from(document.querySelectorAll(".order-select:checked")).filter(x => !x.disabled);
        const chkAll = document.getElementById("chkAll");

        chkAll.checked = (all.length > 0 && selected.length === all.length);
        chkAll.indeterminate = (selected.length > 0 && selected.length < all.length);
    }

    function chunk(arr, size) {
        const out = [];
        for (let i = 0; i < arr.length; i += size) out.push(arr.slice(i, i + size));
        return out;
    }

    function isLatLng(s) {
        return /^-?\d+(\.\d+)?\s*,\s*-?\d+(\.\d+)?$/.test(s);
    }

    function buildStopsFromIds(ids) {
        const missing = [];
        const stops = [];

        for (const id of ids) {
            const s = (STOP_MAP[id] || "").trim();
            if (!s || !isLatLng(s)) missing.push(id);
            else stops.push(s);
        }

        // lo·∫°i tr√πng gi·ªØ th·ª© t·ª±
        const seen = new Set();
        const uniq = [];
        for (const s of stops) {
            if (!seen.has(s)) { seen.add(s); uniq.push(s); }
        }

        return { stops: uniq, missingIds: missing };
    }

    function originParam() {
        if (HUB_ORIGIN && isLatLng(HUB_ORIGIN)) return encodeURIComponent(HUB_ORIGIN);
        return "My+Location";
    }

    function openMapsLatLngOnly(stops, optimize) {
        if (!stops || stops.length === 0) {
            alert("C√°c ƒë∆°n b·∫°n ch·ªçn ch∆∞a c√≥ t·ªça ƒë·ªô Lat/Lng n√™n kh√¥ng th·ªÉ m·ªü route nhi·ªÅu ƒëi·ªÉm.\nH√£y v√†o Chi ti·∫øt t·ª´ng ƒë∆°n ƒë·ªÉ geocode ho·∫∑c nh·ªù admin c·∫≠p nh·∫≠t t·ªça ƒë·ªô.");
            return;
        }

        const ORI = originParam();
        const MAX = 9;

        chunk(stops, MAX).forEach(group => {
            if (group.length === 1) {
                const url = "https://www.google.com/maps/dir/?api=1&origin=" + ORI + "&destination=" + encodeURIComponent(group[0]);
                window.open(url, "_blank");
                return;
            }

            const destination = group[group.length - 1];
            const waypoints = group.slice(0, group.length - 1);

            const wpString = (optimize ? "optimize:true|" : "") + waypoints.join("|");
            const url =
                "https://www.google.com/maps/dir/?api=1" +
                "&origin=" + ORI +
                "&travelmode=driving" +
                "&destination=" + encodeURIComponent(destination) +
                "&waypoints=" + encodeURIComponent(wpString);

            window.open(url, "_blank");
        });
    }

    async function postBatchIfExists(ids) {
        try {
            const res = await fetch("/Taixe/UpdateStatusBatch", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "RequestVerificationToken": getToken()
                },
                body: JSON.stringify({ orderIds: ids, status: "shipping" })
            });

            if (res.status === 404) return { ok: false, skipped: true };
            if (!res.ok) return { ok: false, skipped: false };
            return { ok: true };
        } catch {
            return { ok: false, skipped: true };
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".order-select").forEach(cb => cb.addEventListener("change", refreshSelectedCount));

        document.getElementById("chkAll")?.addEventListener("change", function () {
            const all = getCheckboxes();
            all.forEach(x => x.checked = this.checked);
            refreshSelectedCount();
        });

        document.getElementById("btnMapsBatch")?.addEventListener("click", function () {
            const ids = getSelectedIds();
            if (ids.length === 0) return alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 ƒë∆°n!");

            const optimize = document.getElementById("chkOptimize")?.checked === true;
            const r = buildStopsFromIds(ids);

            if (r.missingIds.length > 0) {
                alert("C√≥ " + r.missingIds.length + " ƒë∆°n ch∆∞a c√≥ t·ªça ƒë·ªô Lat/Lng n√™n s·∫Ω b·ªã b·ªè qua khi m·ªü route nhi·ªÅu ƒëi·ªÉm.");
            }

            openMapsLatLngOnly(r.stops, optimize);
        });

        document.getElementById("btnStartMulti")?.addEventListener("click", async function () {
            const ids = getSelectedIds();
            if (ids.length === 0) return alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 ƒë∆°n!");

            const optimize = document.getElementById("chkOptimize")?.checked === true;
            const r = buildStopsFromIds(ids);

            if (r.missingIds.length > 0) {
                alert("C√≥ " + r.missingIds.length + " ƒë∆°n ch∆∞a c√≥ t·ªça ƒë·ªô Lat/Lng n√™n s·∫Ω b·ªã b·ªè qua khi m·ªü route nhi·ªÅu ƒëi·ªÉm.");
            }

            openMapsLatLngOnly(r.stops, optimize);

            const p = await postBatchIfExists(ids);
            if (p.ok) location.reload();
        });

        refreshSelectedCount();
    });
</script>
}
